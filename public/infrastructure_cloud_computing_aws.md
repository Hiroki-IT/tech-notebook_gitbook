# Amazon Web Service

## 01. コンピューティング｜EC2

### EC2

#### ・EC2とは

クラウドサーバとしては働く．注意点があるものだけまとめる．

| 設定項目                  | 説明                                              |                                                              |
| ------------------------- | ------------------------------------------------- | ------------------------------------------------------------ |
| AMI：Amazonマシンイメージ | OSを選択する．                                    | ベンダー公式のものを選択すること．（例：CentOSのAMI一覧 https://wiki.centos.org/Cloud/AWS） |
| インスタンスの詳細設定    | EC2インスタンスの設定する．                       | ・インスタンス自動割り当てパブリックにて，EC2に動的パブリックIPを割り当てる．EC2インスタンス構築後に有効にできない．<br/>・終了保護は必ず有効にすること． |
| ストレージの追加          | EBSボリュームを設定する．                         | 一般的なアプリケーションであれば，20～30GiBでよい．踏み台サーバの場合，最低限で良いため，OSの下限までサイズを下げる．（例：CentOSの下限は10GiB） |
| キーペア                  | EC2の秘密鍵に対応した公開鍵をインストールできる． | キーペアに割り当てられるフィンガープリント値を調べることで，公開鍵と秘密鍵の対応関係を調べることができる． |


#### ・キーペアのフィンガープリント値

ローカルに置かれている秘密鍵が，該当するEC2に置かれている公開鍵とペアなのかどうか，フィンガープリント値を照合して確認する方法

```bash
$ openssl pkcs8 -in <秘密鍵>.pem -inform PEM -outform DER -topk8 -nocrypt | openssl sha1 -c
```

#### ・EC2へのSSH接続

クライアントのSSHプロトコルもつパケットは，まずインターネットを経由して，インターネットゲートウェイを通過する．その後，Route53，ALBを経由せず，そのままEC2へ向かう．

![SSHポートフォワード](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/SSHポートフォワード.png)

<br>

## 01-02. コンピューティング｜Lambda

### Lambda

![サーバレスアーキテクチャとは](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/サーバレスアーキテクチャとは.png)

#### ・Lambdaとは

Lambdaを軸に他のFaaSと連携させることによって，ユーザ側は関数プログラムを作成しさえすれば，これを実行することができる．この方法を，『サーバレスアーキテクチャ』という．

| 設定項目                   | 説明                                                         | 備考 |
| -------------------------- | ------------------------------------------------------------ | ---- |
| 関数                       | 与えられた引数を元に何らかの計算や処理を行い、結果を呼び出し元に返すもののこと． |      |
| サーバレスアプリケーション | 関数、イベントソース、およびその他のAWSリソースを組み合わせたもののこと． |      |

<br>

### 関数

#### ・関数の詳細項目

| 設定項目     | 説明                                                         | 備考                                                         |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ランタイム   | 関数の実装に使用する言語を設定する．                         |                                                              |
| ハンドラ     | 関数の実行時にコールしたい具体的メソッド名を設定する．       | ・Node.js：```index.js``` というファイル名で ```exports.handler``` メソッドを呼び出したい場合，ハンドラ名を```index.handler```とする |
| メモリ       |                                                              |                                                              |
| タイムアウト |                                                              |                                                              |
| 実行ロール   | Lambda内のメソッドが実行される時に必要なポリシーをもつロールを設定する． |                                                              |

#### ・テストとデバッグ

lambdaで関数を作成すると，CloudWatchLogsのロググループに，「```/aws/lambda/<関数名>```」というグループが自動的に作成される．Lambdaの関数内で発生したエラーや```console.log```メソッドのログはここに出力されるため，都度確認すること．

<br>

### Node.jsによる関数

#### ・AWS-SDKの読み込み

**＊実装例＊**

```javascript
// AWS SDK for JavaScript を読み込む
const aws = require('aws-sdk');
```

#### ・メソッド

```event```，```context```，```callback```の引数にもつメソッドを定義する．初期名は```handler```であるが別名でもよい．

```javascript
exports.MyHandler = (event, context, callback) => {
  // なんらかの処理
}
```

| 引数     | 説明                                       | 備考 |
| -------- | ------------------------------------------ | ---- |
| event    | HTTPリクエストのヘッダーが格納されている． |      |
| context  |                                            |      |
| callback |                                            |      |

#### ・S3へのファイルの保存

**＊実装例＊**

```javascript
const aws = require('aws-sdk');

const s3 = new aws.S3();

exports.handler = (event, context, callback) => {
  
  s3.putObject({
      Bucket: '<バケット名>',
      Key: '<パスを含む保存先ファイル>',
      Body: '<保存データ>',
    },
    (err, data) => {
      if (err) {
          // エラーだった時の処理
    }
      // エラー出なかった時の処理
    });
}
```

また，LambdaがS3に対してアクションを実行できるように，事前に，AWS管理ポリシーの「```AWSLambdaExecute```」が付与されたロールをLambdaにアタッチしておく必要がある．

<br>

### Lambda@Edge

![Lambda@edge](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/Lambda@edge.png)

#### ・Lambda@Edgeとは

CloudFrontのビューワーリクエスト，オリジンリクエスト，オリジンレスポンス，ビューワーレスポンス，をトリガーとするLambdaのこと．エッジロケーションのCloudFrontに，Lambdaのレプリカが構築される．

| トリガーの種類       | 発火のタイミング                                             |
| -------------------- | ------------------------------------------------------------ |
| ビューワーリクエスト | CloudFrontが，ビューワーからリクエストを受信した後（キャッシュを確認する前）． |
| オリジンリクエスト   | CloudFrontが，リクエストをオリジンサーバーに転送する前（キャッシュを確認した後）． |
| オリジンレスポンス   | CloudFrontが，オリジンからレスポンスを受信した後（キャッシュを確認する前）． |
| ビューワーレスポンス | CloudFrontが，ビューワーにレスポンスを転送する前（キャッシュを確認した後）． |

#### ・必要なポリシー

Lambda@Edgeを実行するためには，以下のポリシーが必要である．

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "lambda:GetFunction",
        "lambda:EnableReplication*"
      ],
      "Resource": "arn:aws:lambda:<リージョン名>:<アカウントID>:function:<関数名>:<バージョン>"
    },
    {
      "Effect": "Allow",
      "Action": [
        "iam:CreateServiceLinkedRole"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudfront:UpdateDistribution"
      ],
      "Resource": "arn:aws:cloudfront::<アカウントID>:distribution/<DistributionID>"
    }
  ]
}

```

<br>

## 01-03. コンピューティング｜Security Group

### Security Group

#### ・Security Groupとは

アプリケーションのクラウドパケットフィルタリング型ファイアウォールとして働く．インバウンド通信（プライベートネットワーク向き通信）では，プロトコルや受信元IPアドレスを設定でき，アウトバウンド通信（グローバルネットワーク向き通信）では，プロトコルや送信先プロトコルを設定できる．

#### ・パケットフィルタリング型ファイアウォールとは

パケットのヘッダ情報に記載された送信元IPアドレスやポート番号などによって，パケットを許可するべきかどうかを決定する．速度を重視する場合はこちら．ファイアウォールとWebサーバの間には，NATルータやNAPTルータが設置されている．これらによる送信元プライベートIPアドレスから送信元グローバルIPアドレスへの変換についても参照せよ．

![パケットフィルタリング](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/パケットフィルタリング.gif)

<br>

### インバウンドルール

#### ・セキュリティグループIDの紐づけ

ソースに対して，セキュリティグループIDを設定した場合，そのセキュリティグループがアタッチされているリソース（ネットワークインターフェースを含む）を許可することになる．リソースのIPアドレスが動的に変化する場合，有効な方法である．

#### ・アプリケーションEC2の例

ALBに割り振られる可能性のあるIPアドレスを許可するために，ALBのSecurity GroupのID，またはSubnetのIPアドレス範囲を設定する．

| タイプ | プロトコル | ポート    | ソース                       | 説明                        |
| ------ | ---------- | --------- | ---------------------------- | --------------------------- |
| HTTP   | TCP        | ```80```  | ALBのSecurity Group ID       | HTTP access from ALB        |
| HTTPS  | TCP        | ```443``` | 踏み台EC2のSecurity Group ID | SSH access from bastion EC2 |

#### ・踏み台EC2の例

| タイプ | プロトコル | ポート   | ソース                     | 説明                             |
| ------ | ---------- | -------- | -------------------------- | -------------------------------- |
| SSH    | TCP        | ```22``` | 社内のグローバルIPアドレス | SSH access from global ip addess |

#### ・EFSの例

EC2に割り振られる可能性のあるIPアドレスを許可するために，EC2のSecurity GroupのID，またはSubnetのIPアドレス範囲を設定する．

| タイプ | プロトコル | ポート     | ソース                                 | 説明                    |
| ------ | ---------- | ---------- | -------------------------------------- | ----------------------- |
| NFS    | TCP        | ```2049``` | アプリケーションEC2のSecurity Group ID | NFS access from app EC2 |

#### ・RDSの例

EC2に割り振られる可能性のあるIPアドレスを許可するために，EC2のSecurity GroupのID，またはSubnetのIPアドレス範囲を設定する．

| タイプ       | プロトコル | ポート     | ソース                                 | 説明                      |
| ------------ | ---------- | ---------- | -------------------------------------- | ------------------------- |
| MYSQL/Aurora | TCP        | ```3306``` | アプリケーションEC2のSecurity Group ID | MYSQL access from app EC2 |

#### ・Redisの例

EC2に割り振られる可能性のあるIPアドレスを許可するために，EC2のSecurity GroupのID，またはSubnetのIPアドレス範囲を設定する．

| タイプ      | プロトコル | ポート     | ソース                                 | 説明                    |
| ----------- | ---------- | ---------- | -------------------------------------- | ----------------------- |
| カスタムTCP | TCP        | ```6379``` | アプリケーションEC2のSecurity Group ID | TCP access from app EC2 |

#### ・ALBの例

CloudFrontと連携する場合，CloudFrontに割り振られる可能性のあるIPアドレスを許可するために，全てのIPアドレスを許可する．その代わりに，CloudFrontにWAFを紐づけ，ALBの前でIPアドレスを制限するようにする．CloudFrontとは連携しない場合，ALBのSecurity GroupでIPアドレスを制限するようにする．

| タイプ | プロトコル | ポート    | ソース          | 説明                         |      |
| ------ | ---------- | --------- | --------------- | ---------------------------- | ---- |
| HTTP   | TCP        | ```80```  | ```0.0.0.0/0``` | HTTP access from CloudFront  |      |
| HTTPS  | TCP        | ```443``` | ```0.0.0.0/0``` | HTTPS access from CloudFront |      |

<br>

### アウトバウンドルール

#### ・任意AWSリソースの例

| タイプ               | プロトコル | ポート | 送信先          | 説明        |
| -------------------- | ---------- | ------ | --------------- | ----------- |
| すべてのトラフィック | すべて     | すべて | ```0.0.0.0/0``` | Full access |

<br>

## 01-03. コンピューティングに付随する設定

### Region，Availability Zone

#### ・Regionとは

2016年1月6日時点では，以下のRegionに物理サーバのデータセンターがある．

![AWSリージョンマップ](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/AWSリージョンマップ.PNG)

#### ・Availability Zoneとは

Regionは，さらに，各データセンターは物理的に独立したAvailability Zoneというロケーションから構成されている．例えば，東京Regionには，3つのAvailability Zoneがある．AZの中に，VPC subnetを作ることができ，そこにEC2を構築できる．

<br>

## 02. コンテナ｜ECS on Fargate

![NatGatewayを介したFargateからECRECSへのアウトバウンド通信](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/NatGatewayを介したFargateからECRECSへのアウトバウンド通信.png)

### ECS：Elastc Cotainer Service

#### ・ECSとは

コンテナを管理する環境．VPCの外に存在している．ECS，EKS，Fargate，EC2の対応関係は以下の通り．

| Control Plane（コンテナ管理環境） | Data Plane（コンテナ実行環境） |
| --------------------------------- | ------------------------------ |
| ECS                               | Fargate，EC2                   |
| EKS                               | Fargate，EC2                   |

#### ・クラスター

![ECSクラスター](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/ECSクラスター.png)

<br>

### サービス

#### ・サービスとは

タスク数の維持管理を行う機能のこと．

| 設定項目                     | 説明                                                         | 備考                                                         |
| ---------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| タスク定義                   | サービスで維持管理するタスクの定義ファミリー名とリビジョン番号を設定する． |                                                              |
| 起動タイプ                   | タスク内のコンテナの起動タイプを設定する．                   |                                                              |
| プラットフォームのバージョン | タスクの実行環境のバージョンを設定する．                     | バージョンによって，連携できるAWSリソースが異なる．          |
| サービスタイプ               |                                                              |                                                              |
| 最小ヘルス率                 |                                                              |                                                              |
| 最大率                       |                                                              |                                                              |
| ヘルスチェックの猶予期間     |                                                              |                                                              |
| タスクの最小数               | スケーリング時のタスク数の最小数を設定する．                 |                                                              |
| タスクの必要数               | 平常時のタスク数を設定する．                                 |                                                              |
| タスクの最大数               | スケーリング時のタスク数の最大数を設定する．                 |                                                              |
| ロードバランシング           | ALBでルーティングするコンテナを設定する．                    |                                                              |
| タスクの数                   | タスクの構築数をいくつに維持するかを設定する．               | タスクが何らかの原因で停止した場合，空いているAWSサービスを使用して，タスクが自動的に補填される． |
| デプロイメント               | ローリングアップデート，Blue/Greenデプロイがある．           |                                                              |

#### ・自動タスクスケーリングポリシー

| 設定項目（ターゲットの追跡を選んだ場合） | 説明                                                         | 備考                                                         |
| ---------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ターゲット追跡スケーリングポリシー       | 監視対象のメトリクスがターゲット値を超過しているか否かに基づいて，タスク数のスケーリングが実行される． |                                                              |
| ECSサービスメトリクス                    | 監視対象のメトリクスを設定する．                             | 「平均CPU」，「平均メモリ」，「タスク当たりのALBからのリクエスト数」を監視できる． |
| ターゲット値                             | タスク数のスケーリングが実行される閾値を設定する．           | ターゲット値を超過している場合に，タスク数がスケールアウトされる． |
| スケールアウトクールダウン期間           | スケールアウトを発動してから，次回のスケールアウトを発動できるまでの時間を設定する． | ターゲット値を超過する状態が断続的に続くと，スケールアウトが連続して実行されてしまうため，これを防ぐことができる． |
| スケールインクールダウン期間             | スケールインを発動してから，次回のスケールインを発動できるまでの時間を設定する． |                                                              |
| スケールインの無効化                     |                                                              |                                                              |

1. 最小タスク数を2，必要タスク数を4，最大数を6，CPU平均使用率を40%に設定するとする．
2. 平常時，CPU使用率40%に維持される．
3. リクエストが増加し，CPU使用率55%に上昇する．
4. タスク数が6つにスケールアウトし，CPU使用率40%に維持される．
5. リクエスト数が減少し，CPU使用率が20%に低下する．
6. タスク数が2つにスケールインし，CPU使用率40%に維持される．

#### ・ローリングアップデート

1. ECRのイメージを更新
2. タスク定義の新しいリビジョンを作成．
3. サービスを更新．
4. ローリングアップデートによって，タスク定義を基に，新しいタスクがリリースされる．

#### ・CodeDeployを使用したBlue/Greenデプロイ

![Blue-Greenデプロイ](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/Blue-Greenデプロイ.jpeg)

1. ECRのイメージを更新
2. タスク定義の新しいリビジョンを作成．
3. サービスを更新．
4. CodeDeployによって，タスク定義を基に，現行の本番環境（Prodブルー）のタスクとは別に，テスト環境（Testグリーン）が構築される．ロードバランサーの接続先を本番環境（Prodブルー）のターゲットグルーップ（Primaryターゲットグループ）から，テスト環境（Testグリーン）のターゲットグループに切り替える．テスト環境（Testグリーン）で問題なければ，これを新しい本番環境としてリリースする．

<br>

### タスク

![タスクとタスク定義](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/タスクとタスク定義.png)

#### ・タスク

グルーピングされたコンテナ群のこと

#### ・タスク定義とは

各タスクをどのような設定値（```json```形式ファイル）に基づいて構築するかを設定できる．タスク定義は，バージョンを示す「リビジョンナンバー」で番号づけされる．タスク定義を削除するには，全てのリビジョン番号のタスク定義を登録解除する必要がある．

#### ・タスク実行ロール

タスク上に存在するコンテナエージェントが，タスクを起動するために必要なロールのこと．AWS管理ポリシーである「```AmazonECSTaskExecutionRolePolicy```」が付与されたロールを，タスクにアタッチする必要がある．このポリシーには，ECRへのアクセス権限の他，CloudWatch Logsにログを生成するための権限が設定されている．タスク内のコンテナに必要なタスクロールとは区別すること．

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ecr:GetAuthorizationToken",
        "ecr:BatchCheckLayerAvailability",
        "ecr:GetDownloadUrlForLayer",
        "ecr:BatchGetImage",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "*"
    }
  ]
}
```

#### ・割り当てられるプライベートIPアドレス

タスクごとに異なるプライベートIPが割り当てられる．このIPアドレスに対して，ALBはルーティングを行う．

#### ・ネットワークモードの詳細項目

| 設定項目 | 相当するDockerのネットワーク機能 | 備考                                                         |
| -------- | -------------------------------- | ------------------------------------------------------------ |
| bridge   | bridgeネットワーク               |                                                              |
| host     | hostネットワーク                 |                                                              |
| awsvpc   | awsの独自ネットワーク機能．      | タスクはElastic Network Interfaceと紐づけられ，PrimaryプライベートIPアドレスを割り当てられる． |

#### ・タスクサイズの詳細項目


| 設定項目     | 説明                                     |
| ------------ | ---------------------------------------- |
| タスクメモリ | タスク当たりのコンテナの合計メモリ使用量 |
| タスクCPU    | タスク当たりのコンテナの合計CPU使用量    |

<br>

### Fargate起動タイプのコンテナ

#### ・コンテナエージェント

コンテナ内で稼働し，コンテナの操作を行うプログラムのこと．

#### ・コンテナ定義の詳細項目

タスク内のコンテナ一つに対して，環境を設定する．

https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/userguide/task_definition_parameters.html

| 設定項目                                    | 対応するdockerコマンドオプション             | 説明                                                         | 備考                                                         |
| ------------------------------------------- | -------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| cpu                                         | ```--cpus```                                 | 仮想cpu数を設定する．                                        |                                                              |
| dnsServers                                  | ```--dns```                                  | コンテナが名前解決に使用するDNSサーバのIPアドレスを設定する． |                                                              |
| essential                                   |                                              | コンテナが必須か否かを設定する．                             | ・```true```の場合，コンテナが停止すると，タスクに含まれる全コンテナが停止する．<br>```false```の場合，コンテナが停止しても，その他のコンテナは停止しない． |
| healthCheck<br>(command)                    | ```--health-cmd```                           | ホストマシンからFargateに対して，```curl```コマンドによるリクエストを送信し，レスポンス内容を確認． |                                                              |
| healthCheck<br>(interval)                   | ```--health-interval```                      | ヘルスチェックの間隔を設定する．                             |                                                              |
| healthCheck<br>(retries)                    | ```--health-retries```                       | ヘルスチェックを成功と見なす回数を設定する．                 |                                                              |
| hostName                                    | ```--hostname```                             | コンテナにホスト名を設定する．                               |                                                              |
| image                                       |                                              | ECRのURLを設定する．                                         |                                                              |
| logConfiguration<br/>(awslogs-group)        |                                              | ログを送信するロググループを設定する．                       |                                                              |
| logConfiguration<br>(awslogs-stream-prefix) |                                              | ログストリームのプレフィックス名を設定する．                 | ログストリームには，「```<プレフィックス名>/<コンテナ名>/<タスクID>```」の形式で送信される． |
| portMapping                                 | ```--publish```                              | ホストマシンとFargateのアプリケーションのポート番号をマッピングし，ポートフォワーディングを行う． |                                                              |
| secrets<br>(volumesFrom)                    |                                              | SSMパラメータストアから参照する変数を設定する．              |                                                              |
| memory                                      | ```--memory```<br>```--memory-reservation``` | プロセスが使用できるメモリの閾値を設定する．                 |                                                              |
| mountPoints                                 |                                              |                                                              |                                                              |
| ulimit                                      | Linuxコマンドの<br>```--ulimit```に相当      |                                                              |                                                              |

<br>

### Fargate起動タイプ

#### ・割り当てられるパブリックIPアドレス，FargateのIPアドレス問題

FargateにパブリックIPアドレスを持たせたい場合，Elastic IPアドレスの設定項目がなく，動的パブリックIPアドレスしか設定できない（Fargateの再構築後に変化する）．アウトバウンド通信の先にある外部サービスが，セキュリティ上で静的なIPアドレスを要求する場合，アウトバウンド通信（グローバルネットワーク向き通信）時に送信元パケットに付加されるIPアドレスが動的になり，リクエストができなくなってしまう．

![NatGatewayを介したFargateから外部サービスへのアウトバウンド通信](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/NatGatewayを介したFargateから外部サービスへのアウトバウンド通信.png)

そこで，Fargateのアウトバウンド通信が，Elastic IPアドレスを持つNAT Gatewayを経由するようにする（Fargateは，パブリックサブネットとプライベートサブネットのどちらに置いても良い）．これによって，Nat GatewayのElastic IPアドレスが送信元パケットに付加されるため，Fargateの送信元IPアドレスを見かけ上静的に扱うことができるようになる．

#### ・ECRに対するDockerイメージのプル

FargateからECRに対するDockerイメージのプルは，アウトバウンド通信（グローバルネットワーク向き通信）である．以下の通り，NAT Gatewayを設置したとする．この場合，ECSやECRとのアウトバウンド通信がNAT Gatewayを通過するため，高額料金を請求されてしまう．

![NatGatewayを介したFargateからECRECSへのアウトバウンド通信](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/NatGatewayを介したFargateからECRECSへのアウトバウンド通信.png)

そこで，一つの方法として，ECR用のVPCエンドポイントを設け，これに対してアウトバウンド通信を行う設計方法がある．

![PrivateLinkを介したFargateからECRECSへのアウトバウンド通信](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/PrivateLinkを介したFargateからECRECSへのアウトバウンド通信.png)

同様に，リクエストを送信するために，VPCエンドポイントを設ける必要があるサービスが以下の通り．

| リソース        | VPCエンドポイントのサービス名        | 説明                                       |
| --------------- | ------------------------------------ | ------------------------------------------ |
| ECR             | com.amazonaws.ap-northeast-1.ecr.api | イメージのGETリクエストを行うため          |
| ECR             | com.amazonaws.ap-northeast-1.ecr.dkr | イメージのGETリクエストを行うため          |
| CloudWatch Logs | com.amazonaws.ap-northeast-1.logs    | ECSコンテナのログをPOSTリクエストするため  |
| S3              | com.amazonaws.ap-northeast-1.s3      | イメージのレイヤーをPOSTリクエストするため |

<br>

### ECR

#### ・ライフサイクルポリシー

ECRのイメージの有効期間を定義できる．

| 設定項目             | 説明                                                         | 備考                                                         |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ルールの優先順位     | 順位の大きさで，ルールの優先度を設定できる．                 | 数字は連続している必要はなく，例えば，10，20，90，のように設定しても良い． |
| イメージのステータス | ルールを適用するイメージの条件として，タグの有無や文字列を設定できる． |                                                              |
| 一致条件             | イメージの有効期間として，同条件に当てはまるイメージが削除される閾値を設定できる． | 個数，プッシュされてからの期間，などを閾値として設定できる． |

#### ・タグの変性／不変性

<br>

## 02-02. コンテナ｜ECS on EC2

### EC2起動タイプのコンテナ

#### ・タスク配置戦略

タスクをインスタンスに配置する時のアルゴリズムを選択できる．

| 戦略    | 説明                                         |
| ------- | -------------------------------------------- |
| Spread  | タスクを各場所にバランスよく配置する         |
| Binpack | タスクを一つの場所にできるだけ多く配置する． |
| Random  | タスクをランダムに配置する．                 |

<br>

## 03. ストレージ

### EBS：Elastic Block Storage

#### ・EBSとは

クラウド内蔵ストレージとして働く．

#### ・ストレージの種類とボリュームタイプ

| ストレージの種類 | ボリューム名            |
| ---------------- | ----------------------- |
| SSD              | 汎用SSD                 |
| SSD              | プロビジョンド IOPS SSD |
| HDD              | スループット最適化 HDD  |
| HDD              | Cold HDD                |

#### ・最小ボリューム

踏み台サーバを構築する時，できるだけ最小限のボリュームを選択し，ストレージ合計を抑える必要がある．

| OS           | 仮想メモリ | ボリュームサイズ |
| ------------ | ---------- | ---------------- |
| Amazon Linux | t2.micro   | 8                |
| CentOS       | t2.micro   | 10               |

<br>

### EFS：Elastic File System

![EFSのファイル共有機能](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/EFSのファイル共有機能.png)

#### ・EFSとは

マウントターゲットと接続されたEC2インスタンスから，ファイルを自身に転送し，これを管理する．ファイルの実体はEFSの中に存在しているため，接続を切断している間，EC2インスタンス内のファイルは無くなる．再接続すると，切断直前のファイルが再び表示されようになる．

| 設定項目                 | 説明                                                         | 備考                                                         |
| ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ファイルシステム         | EFSに関する設定                                              |                                                              |
| ネットワークアクセス     | マウントターゲットを設置するサブネット，セキュリティグループを設定 | ・サブネットは，ファイル供給の速度の観点から，マウントターゲットにアクセスするAWSリソースと同じにする．<br>・セキュリティグループは，EC2からのNFSプロトコルアクセスを許可したものを設定する．EC2のセキュリティグループを通過したアクセスだけを許可するために，IPアドレスでは，EC2のセキュリティグループを設定する． |
| ファイルシステムポリシー | AWSリソースがEFSを利用する時のポリシーを設定する．           |                                                              |

#### ・マウントコマンド

DNS経由で，EFSマウントヘルパーを使用した場合を示す．

```bash
$ mount -t <ファイルシステムタイプ> -o tls <ファイルシステムID>:/ <マウントポイント>
```

```bash
# Amazon EFSで，マウントポイントを登録
$ mount -t efs -o tls fs-xxxxx:/ /var/www/app

# マウントポイントを解除
$ umount /var/www/app

# dfコマンドでマウントしているディレクトリを確認できる
$ df
Filesystem                                1K-blocks Used Available Use% Mounted on
fs-xxx.efs.ap-northeast-1.amazonaws.com:/ xxx       xxx  xxx       1%   /var/www/cerenavi
```

<br>

## 03-02. ストレージ｜S3

### S3：Simple Storage Service

#### ・S3とは

クラウド外付けストレージとして働く．Amazon S3に保存するCSSファイルや画像ファイルを管理できる．

| 設定項目             | 説明                       |
| -------------------- | -------------------------- |
| バケット             | バケットに関して設定する． |
| バッチオペレーション |                            |
| アクセスアナライザー |                            |

#### ・プロパティの詳細項目

| 設定項目                     | 説明 | 備考 |
| ---------------------------- | ---- | ---- |
| バージョニング               |      |      |
| サーバアクセスのログ記録     |      |      |
| 静的サイトホスティング       |      |      |
| オブジェクトレベルのログ記録 |      |      |
| デフォルト暗号化             |      |      |
| オブジェクトのロック         |      |      |
| Transfer acceleration        |      |      |
| イベント                     |      |      |
| リクエスタ支払い             |      |      |

#### ・外部／内部ネットワークからのアクセス制限の詳細項目

| 設定項目                   | 説明                                                        | 備考                                                         |
| -------------------------- | ----------------------------------------------------------- | ------------------------------------------------------------ |
| ブロックパブリックアクセス | パブリックネットワークとVPCからのアクセスの許否を設定する． | ・パブリックアクセスを有効にすると，パブリックネットワークから「```https://<バケット名>.s3.amazonaws.com```」というようにURLを指定して，S3にアクセスできるようになる．ただし非推奨．<br>・パブリックアクセスを全て無効にすると，パブリックネットワークとVPCの全アクセスを遮断できる．ただし，アクセスロールまたはバケットポリシーを用いて，特定のAWSリソースからのアクセスを許可できる． |
| アクセスコントロールリスト |                                                             |                                                              |
| バケットポリシー           | S3へのアクセスをポリシーで管理する．                        | ポリシーを付与できない，CloudFront，ALB，などが自身へのアクセスログを生成するために必要．EC2のアクセス権限は，EC2にS3アクセスロールを付与できるので不要． |
| CORSの設定                 |                                                             |                                                              |

#### ・AWS-CLI

**＊コマンド例＊**

```bash
# 指定したバケット内のファイル名を表示
$ aws s3 ls s3://<バケット名>
```

<br>

### バケットポリシーの例

#### ・S3のARNについて

ポリシーにおいて，S3のARでは，「```arn:aws:s3:::<バケット名>/*```」のように，最後にバックスラッシュアスタリスクが必要．

#### ・ALBのアクセスログの保存を許可

パブリックアクセスが無効化されたS3に対して，ALBへのアクセスログを保存したい場合，バケットポリシーを設定する必要がある．バケットポリシーには，ALBからS3へのログ書き込み権限を実装する．「```"AWS": "arn:aws:iam::582318560864:root"```」において，```582318560864```は，ALBアカウントIDと呼ばれ，リージョンごとに値が決まっている．これは，東京リージョンのアカウントIDである．

**＊実装例＊**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::582318560864:root"
      },
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::<バケット名>/*"
    }
  ]
}
```

#### ・CloudFrontのファイル読み出しを許可

パブリックアクセスが無効化されたS3に対して，CloudFrontからのルーティングで静的ファイルを読み出したい場合，バケットポリシーを設定する必要がある．

**＊実装例＊**

```json
{
  "Version": "2008-10-17",
  "Id": "PolicyForCloudFrontPrivateContent",
  "Statement": [
    {
      "Sid": "1",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity <OAIのID番号>"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::<バケット名>/*"
    }
  ]
}
```

#### ・CloudFrontのアクセスログの保存を許可

2020-10-08時点の仕様では，パブリックアクセスが無効化されたS3に対して，CloudFrontへのアクセスログを保存することはできない．よって，危険ではあるが，パブリックアクセスを有効化する必要がある．

```json
// ポリシーは不要
```

#### ・Lambdaからのアクセスを許可

バケットポリシーは不要である．代わりに，AWS管理ポリシーの「```AWSLambdaExecute```」が付与されたロールをLambdaにアタッチする必要がある．このポリシーには，S3へのアクセス権限の他，CloudWatch Logsにログを生成するための権限が設定されている．

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:*"
      ],
      "Resource": "arn:aws:logs:*:*:*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::*"
    }
  ]
}
```

#### ・特定のIPアドレスからのアクセスを許可

パブリックネットワーク上の特定のIPアドレスからのアクセスを許可したい場合，そのIPアドレスをポリシーに設定する必要がある．

```json
{
  "Version": "2012-10-17",
  "Id": "S3PolicyId1",
  "Statement": [
    {
      "Sid": "IPAllow",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::<バケット名>/*",
      "Condition": {
        "IpAddress": {
          "aws:SourceIp": "<IPアドレス>/32"
        }
      }
    }
  ]
}
```

<br>

## 04. データベース

### Amazon RDS：Amazon Relational Database Service

#### ・Amazon RDSとは

| 設定項目             | 説明                                                         | 備考                                                         |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| エンジンのオプション | データベースエンジンの種類を設定                             |                                                              |
| エディション         | Amazon Auroraを選んだ場合の互換性を設定する．                |                                                              |
| キャパシティタイプ   |                                                              |                                                              |
| レプリケーション機能 |                                                              |                                                              |
| DBクラスター識別子   | クラスター名を設定する．                                     | インスタンス名は，最初に設定できず，RDSの構築後に設定できる． |
| マスタユーザ名       | データベースのrootユーザを設定                               |                                                              |
| マスターパスワード   | データベースのrootユーザのパスワードを設定                   |                                                              |
| DBインスタンスサイズ | データベースのインスタンスのスペックを設定する．             | バースト可能クラスを選ぶこと                                 |
| マルチAZ配置         | プライマリインスタンスとは別に，リーダーレプリカをマルチAZ配置で追加するかどうかを設定する． |                                                              |
| 最初のデータベース名 | データベースに自動的に構築されるデータベース名を設定         |                                                              |
| サブネットグループ   | データベースにアクセスできるサブネットを設定する．           |                                                              |
| パラメータグループ   | グローバルパラメータを設定する．                             | 新しく作成したクラスタパラメータグループにて以下を設定する．<br>・```time_zone=Asia/Tokyo```<br>・```character_set_client=utf8mb4```<br/>・```character_set_connection=utf8mb4```<br/>・```character_set_database=utf8mb4```<br/>・```character_set_results=utf8mb4```<br/>・```character_set_server=utf8mb4```<br>・```server_audit_logging=1```<br/>・```server_audit_logs_upload=1```<br/>・```general_log=1```<br/>・```slow_query_log=1```<br/>・```long_query_time=3``` |
| ログのエクスポート   | 必ず，全てのログを選択すること．                             |                                                              |

#### ・データベースエンジン，RDB，DBMSの対応関係

Amazon RDSでは，データベースエンジン，RDB，DBMSを選べる．

| データベースエンジンの種類 | RDBの種類              | DBMSの種類        |
| -------------------------- | ---------------------- | ----------------- |
| Amazon Aurora              | Amazon Aurora          | MySQL／PostgreSQL |
| MariaDB                    | MariaDBデータベース    | MariaDB           |
| MySQL                      | MySQLデータベース      | MySQL             |
| PostgreSQL                 | PostgreSQLデータベース | PostgreSQL        |

#### ・Amazon RDSのセキュリティグループ

コンピューティングからのインバウンド通信のみを許可するように，これらのプライベートIPアドレス（```n.n.n.n/32```）を設定する．

#### ・データベースクラスターのエンドポイント

![RDSエンドポイント](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/RDSエンドポイント.png)

インスタンス群に対して，以下のエンドポイントが提供される．

```
# 読み出し／書き込みインスタンス群のエンドポイント
xxxxx-cluster.cluster-abcde12345.ap-northeast-1.rds.amazonaws.com
```

```
# 読み出しオンリーインスタンス群のエンドポイント
xxxxx-cluster.cluster-ro-abcde12345.ap-northeast-1.rds.amazonaws.com
```

読み出しオンリーエンドポイントに対して，READ以外の処理を行うと，以下の通り，エラーとなる．


```sql
/* SQL Error (1290): The MySQL server is running with the --read-only option so it cannot execute this statement */
```

#### ・データベースインスタンスの種類

|                    | 読み出し／書き込みインスタンス                               | 読み出しオンリーインスタンス                                 |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **別名**           | プライマリインスタンス                                       | リードレプリカインスタンス                                   |
| **CRUD制限**       | 制限なし．ユーザ権限に依存する．                             | ユーザ権限の権限に関係なく，READしか実行できない．           |
| **エンドポイント** | 各インスタンスに，リージョンのイニシャルに合わせたエンヂポイントが割り振られる． | 各インスタンスに，リージョンのイニシャルに合わせたエンヂポイントが割り振られる． |

<br>

### ElastiCache

#### ・ElastiCacheとは

アプリケーションの代わりに，セッション，クエリCache，を管理する．RedisとMemcachedがある．

| Redis  | Memcached |
| ------ | --------- |
| 要学習 | 要学習    |
| 要学習 | 要学習    |
| 要学習 | 要学習    |

#### ・コマンド

```bash
# Redis接続コマンド
$ /usr/local/sbin/redis-stable/src/redis-cli -c -h <Redisのホスト名> -p 6379
```

```bash
# Redis接続中の状態
# 全てのキーを表示
redis xxxxx:6379> keys *
```

```bash
# Redis接続中の状態
# キーを指定して，対応する値を表示
redis xxxxx:6379> type <キー名>
```

```bash
# Redis接続中の状態
# Redisが受け取ったコマンドをフォアグラウンドで表示
redis xxxxx:6379> monitor
```

#### ・セッション管理機能

![ElastiCacheのセッション管理機能](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/ElastiCacheのセッション管理機能.png)

EC2インスタンスの冗長化時，これらの間で共通のセッションを使用できるように，セッションを管理する．

#### ・クエリCache管理機能

![ElastiCacheのクエリCache管理機能](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/ElastiCacheのクエリキャッシュ管理機能.png)

1. SQLの実行結果を管理する．最初，EC2インスタンスからRDSにSQLが実行される時，SQLの実行結果を保存しておく．

```mysql
# アプリケーションがSQLを実行する
SELECT * FROM users;
```

```bash
# ElastiCacheには，SQLの実行結果がまだ保存されていない
*** no cache ***
{"id"=>"1", "name"=>"alice"}
{"id"=>"2", "name"=>"bob"}
{"id"=>"3", "name"=>"charles"}
{"id"=>"4", "name"=>"donny"}
{"id"=>"5", "name"=>"elie"}
{"id"=>"6", "name"=>"fabian"}
{"id"=>"7", "name"=>"gabriel"}
{"id"=>"8", "name"=>"harold"}
{"id"=>"9", "name"=>"Ignatius"}
{"id"=>"10", "name"=>"jonny"}
```

2. 以降，同じSQLが実行された時には，RDSの代わりにデータをアプリケーションに渡す．

```mysql
# アプリケーションが１番と同じSQLを実行する
SELECT * FROM users;
```


```bash
# ElastiCacheには，SQLの実行結果が既に保存されている
*** cache hit ***
{"id"=>"1", "name"=>"alice"}
{"id"=>"2", "name"=>"bob"}
{"id"=>"3", "name"=>"charles"}
{"id"=>"4", "name"=>"donny"}
{"id"=>"5", "name"=>"elie"}
{"id"=>"6", "name"=>"fabian"}
{"id"=>"7", "name"=>"gabriel"}
{"id"=>"8", "name"=>"harold"}
{"id"=>"9", "name"=>"Ignatius"}
{"id"=>"10", "name"=>"jonny"}
```

<br>

## 05. ネットワーキング，コンテンツ配信｜API Gateway

### API Gateway

![APIGatewayの仕組み](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/APIGatewayの仕組み.png)

#### ・API Gatewayとは

API Gatewayは，メソッドリクエスト，統合リクエスト，統合レスポンス，メソッドレスポンス，から構成される．

| 設定項目                 | 説明                                                         | 備考                                                         |
| ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| AWSリソース              | エンドポイント，HTTPメソッド，転送先，などを設定する．       | 作成したAWSリソースのパスが，APIGatewayのエンドポイントになる． |
| ステージ                 | APIGatewayをデプロイする環境を定義する．                     |                                                              |
| オーソライザー           |                                                              |                                                              |
| ゲートウェイのレスポンス |                                                              |                                                              |
| モデル                   |                                                              |                                                              |
| リソースポリシー         |                                                              |                                                              |
| ドキュメント             |                                                              |                                                              |
| ダッシュボード           |                                                              |                                                              |
| その他の設定             |                                                              |                                                              |
| 使用量プラン             |                                                              |                                                              |
| APIキー                  | APIキーによる認可を設定する．                                |                                                              |
| クライアント証明書       |                                                              |                                                              |
| CloudWatchLogsの設定     | APIGatewayがCloudWatchLogsにアクセスできるよう，ロールを設定する． | 一つのAWS環境につき，一つのロールを設定すればよい．          |

<br>

### リソース

#### ・リソースの詳細項目

| 順番 | 処理               | 説明                                                         | 備考                                                         |
| ---- | ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1    | メソッドリクエスト | クライアントから送信されたデータのうち，実際に転送するデータのフィルタリングを行う． |                                                              |
| 2    | 統合リクエスト     | 指定のリソースに転送するデータを設定する．                   |                                                              |
| 3    | 統合レスポンス     |                                                              | 統合リクエストでプロキシ統合を使用する場合，統合レスポンスを使用できなくなる． |
| 4    | メソッドレスポンス | レスポンスが成功した場合，クライアントに送信するステータスコードを設定する． |                                                              |

#### ・メソッドリクエストの詳細項目

| 設定項目                  | 説明 | 備考 |
| ------------------------- | ---- | ---- |
| 認可                      |      |      |
| リクエストの検証          |      |      |
| APIキーの必要性           |      |      |
| URLクエリ文字列パラメータ |      |      |
| HTTPリクエストヘッダー    |      |      |
| リクエスト本文            |      |      |
| SDK設定                   |      |      |

#### ・統合リクエストの詳細項目

| 設定項目                     | 説明                                                         | 備考                                                         |
| ---------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 統合タイプ                   | リクエストの転送先を設定する．                               |                                                              |
| VPCリンク                    |                                                              |                                                              |
| プロキシ統合                 | HTTPリクエストの各種ヘッダーデータをメタデータでラッピングするかどうかを設定する． | ・基本的には有効化が推奨される．<br>・Lambdaプロキシ統合の場合，Lamba関数が各種ヘッダーデータを取り出して使用できるようになる． |
| エンドポイントURL            | エンドポイントで受信したリクエストのルーティング先URLを設定する． |                                                              |
| デフォルトタイムアウトの使用 |                                                              |                                                              |
| URLパスパラメータ            |                                                              |                                                              |
| URLクエリ文字列パラメータ    |                                                              |                                                              |
| HTTPヘッダー                 |                                                              |                                                              |

#### ・テスト

| 設定項目       | 設定例                 | 備考                                               |
| -------------- | ---------------------- | -------------------------------------------------- |
| クエリ文字     |                        |                                                    |
| ヘッダー       | ```X-API-Token:test``` | 波括弧，スペース，クオーテーションは不要．         |
| リクエスト本文 | {test:"test"}          | 改行タグやスペースが入り込まないよう，整形しない． |

<br>

### ステージ

#### ・ステージの詳細設定

| 設定項目       | 説明 | 備考 |
| -------------- | ---- | ---- |
| その他の設定   |      |      |
| ログ／トレース |      |      |
| ステージ変数   |      |      |
| SDKの生成      |      |      |
| Canary         |      |      |

<br>

## 05-02. ネットワーキング，コンテンツ配信｜Route53

### Route53

#### ・Route53とは

クラウドDNSサーバーとして働く．リクエストされた完全修飾ドメイン名とEC2のグローバルIPアドレスをマッピングしている．

| 設定項目       | 説明                                                         |
| -------------- | ------------------------------------------------------------ |
| ホストゾーン   | ドメイン名を設定する．                                       |
| レコードセット | 名前解決時のルーティング方法を設定する．<br>※ サブドメイン名を扱うことも可能． |

<br>

### ホストゾーン

#### ・レコードタイプの設定値の違い

| レコードタイプ |                                                              | 備考                                |
| -------------- | ------------------------------------------------------------ | ----------------------------------- |
| A              | リクエストを転送したいAWSリソースの，IPv4アドレスまたはDNS名を設定する． |                                     |
| AAAA           | リクエストを転送したいAWSリソースの，IPv6アドレスまたはDNS名を設定する． |                                     |
| CNAME          | リクエストを転送したい任意のサーバのドメイン名を設定する．   | 転送先はAWSリソースでなくともよい． |
| MX             | リクエストを転送したいメールサーバのドメイン名を設定する．   |                                     |
| TXT            | リクエストを転送したいサーバのドメイン名に関連付けられた文字列を設定する． |                                     |

#### ・リソースのDNS名，ドメイン名，エンドポイント名

リソースのDNS名は，以下の様に決定される．

| 種別             | リソース   | 例                                                           |
| ---------------- | ---------- | ------------------------------------------------------------ |
| DNS名            | ALB        | ```<ALB名>-<ランダムな文字列>.<リージョン>.elb.amazonaws.com``` |
|                  | EC2        | ```ec2-<パブリックIPをハイフン区切りにしたもの>.<リージョン>.compute.amazonaws.com``` |
| ドメイン名       | CloudFront | ```<ランダムな文字列>.cloudfront.net```                      |
| エンドポイント名 | S3         | ```<バケット名>.<リージョン>.amazonaws.com```                |

#### ・レコードタイプの名前解決方法の違い

![URLと電子メールの構造](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/URLと電子メールの構造.png)

| レコードタイプ | 名前解決方法（1）  |      |      （2）       |      |     （3）      |
| -------------- | :----------------: | :--: | :--------------: | :--: | :------------: |
| A              | 完全修飾ドメイン名 |  →   |  パブリックIPv4  |  →   |       -        |
| AAAA           | 完全修飾ドメイン名 |  →   |  パブリックIPv6  |  →   |       -        |
| CNAME          | 完全修飾ドメイン名 |  →   | （リダイレクト） |  →   | パブリックIPv4 |

#### ・CloudFrontへのルーティング

CloudFrontにルーティングする場合，CloudFrontのCNAMEをレコード名とすると，CloudFrontのデフォルトドメイン名（```xxxxx.cloudfront.net.```）が，入力フォームに表示されるようになる．

#### ・Route53を含む多数のDNSサーバによって名前解決される仕組み

![Route53を含む名前解決の仕組み](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/Route53を含む名前解決の仕組み.png)

（1）完全修飾ドメイン名に対応するIPアドレスのレスポンス

1. クライアントPCは，完全修飾ドメイン名を，フォワードプロキシサーバ（キャッシュDNSサーバ）にリクエスト．

2. フォワードプロキシサーバは，完全修飾ドメイン名を，リバースプロキシサーバに代理リクエスト．

3. リバースプロキシサーバは，完全修飾ドメイン名を，DNSサーバ（ネームサーバ）に代理リクエスト．

4. Route53は，DNSサーバとして機能する．完全修飾ドメイン名にマッピングされるIPv4アドレスを取得し，リバースプロキシサーバにレスポンス．


|      完全修飾ドメイン名      |  ⇄   |     IPv4アドレス      |
| :--------------------------: | :--: | :-------------------: |
| ```http://www.example.com``` |      | ```203.142.205.139``` |


5. リバースプロキシサーバは，IPv4アドレスを，フォワードプロキシサーバに代理レスポンス．（※ NATによるIPv4アドレスのネットワーク間変換が起こる）

6. フォワードプロキシサーバは，IPv4アドレスを，クライアントPCに代理レスポンス．

（2）IPアドレスに対応するWebページのレスポンス

1. クライアントPCは，レスポンスされたIPv4アドレスを基に，Webページを，リバースプロキシサーバにリクエスト．
2. リバースプロキシサーバは，Webページを，Webサーバに代理リクエスト．
3. EC2は，Webページを，リバースプロキシサーバにレスポンス．
4. リバースプロキシサーバは，Webページを，クライアントPCに代理レスポンス．

#### ・Route53におけるDNSキャッシュ

ルートサーバは世界に13機しか存在しておらず，世界中の名前解決のリクエストを全て処理することは現実的に不可能である．そこで，IPアドレスとドメイン名の関係をキャッシュするプロキシサーバ（キャッシュDNSサーバ）が使用されている．基本的には，プロキシサーバとDNSサーバは区別されるが，Route53はプロキシサーバとDNSサーバの機能を両立している．

<br>

### リゾルバー

#### ・リゾルバーとは

要勉強．

<br>

## 05-03. ネットワーキング，コンテンツ配信｜CloudFront

### CloudFront

![AWSのクラウドデザイン一例](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/CloudFrontによるリクエストの振り分け.png)

#### ・CloudFrontとは

クラウドリバースプロキシサーバとして働く．VPCの外側（パブリックネットワーク）に設置されている．オリジンサーバ（コンテンツ提供元）をS3とした場合，動的コンテンツへのリクエストをEC2に振り分ける．また，静的コンテンツへのリクエストをCacheし，その上でAmazon S3へ振り分ける．次回以降の静的コンテンツのリンクエストは，CloudFrontがレンスポンスを行う．

| 設定項目            | 説明 |
| ------------------- | ---- |
| Distributions       |      |
| Reports & analytics |      |

<br>

### Distributions

#### ・Distributionsの詳細項目

[参考になったサイト](https://www.geekfeed.co.jp/geekblog/wordpress%E3%81%A7%E6%A7%8B%E7%AF%89%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%82%A6%E3%82%A7%E3%83%96%E3%82%B5%E3%82%A4%E3%83%88%E3%81%ABcloudfront%E3%82%92%E7%AB%8B%E3%81%A6%E3%81%A6%E9%AB%98/)

| 設定項目                 | 説明                                                     |
| ------------------------ | -------------------------------------------------------- |
| General                  |                                                          |
| Origin and Origin Groups | コンテンツを提供するAWSリソースを設定                    |
| Behavior                 | オリジンにリクエストが行われた時のCloudFrontの挙動を設定 |
| ErrorPage                |                                                          |
| Restriction              |                                                          |
| Invalidation             | CloudFrontに保存されているCacheを削除できる．            |

#### ・Generalの詳細項目

| 設定項目            | 説明                                                         | 備考                                                         |
| ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Price Class         | 使用するエッジロケーションを設定する．                       | Asiaが含まれているものを選択．                               |
| AWS WAF             | CloudFrontに紐づけるWAFを設定する．                          |                                                              |
| CNAME               | CloudFrontのデフォルトドメイン名（```xxxxx.cloudfront.net.```）に紐づけるRoute53レコード名を設定する． | ・Route53からルーティングする場合は必須．<br>・複数のレコード名を設定できる． |
| SSL Certificate     | HTTPSプロトコルでオリジンに転送する場合に設定する．          | 上述のCNAMEを設定した場合，SSL証明書が別途必要になる．また，Certificate Managerを使用する場合，この証明書は『バージニア北部』で申請する必要がある． |
| Default Root Object | クライアントからのリクエストがドキュメントルートの場合に，オリジンの他のパスに転送するかどうかを設定． | Webサーバで制御できるので，基本的には不要．                  |
| Standard Logging    | CloudFrontのアクセスログをS3に生成するかどうかを設定する．   |                                                              |

#### ・Origin and Origin Groupsの詳細項目

| 設定項目               | 説明                                                         | 備考                                                         |
| ---------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Origin Domain Name     | CloudFrontを経由してコンテンツを提供するAWSリソースのエンドポイントやDNS名を設定する． | ・例えば，S3のエンドポイント，ALBのDNS名を設定する．<br>・別アカウントのAWSリソースのDNS名であってもよい． |
| Origin Access Identity | リクエストの転送先となるAWSリソースでアクセス権限の付与が必要な場合に設定する．転送先のAWSリソースでは，アクセスポリシーを付与する． | CloudFrontがS3に対して読み出しを行うために必要．             |
| Origin Protocol Policy | リクエストの転送先となるAWSリソースに対して，HTTPとHTTPSのいずれのプロトコルで転送するかを設定する． | ・ALBで必要．ALBのリスナーのプロトコルに合わせて設定する．<br>・```HTTP Only```：HTTPで転送<br/>・```HTTPS Only```：HTTPSで転送<br/>・```Match Viewer```：両方で転送 |
| HTTPポート             | 転送時に指定するオリジンのHTTPのポート番号                   |                                                              |
| HTTPSポート            | 転送時に指定するオリジンのHTTPSのポート番号                  |                                                              |

#### ・Behaviorの詳細項目

| 設定項目                                | 説明                                                         | 備考                                                         |
| --------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Precedence                              | 処理の優先順位．                                             | 最初に作成したBehaviorが「```Default (*)```」となり，これは後から変更できないため，主要なBehaviorをまず最初に設定する． |
| Path Pattern                            | Behaviorを行うファイルパスを設定する．                       |                                                              |
| Origin or Origin Group                  | Behaviorを行うオリジンを設定する．                           |                                                              |
| Viewer Protocol Policy                  | HTTP／HTTPSのどちらを受信するか，またどのように変換して転送するかを設定 | ・```HTTP and HTTPS```：両方受信し，そのまま転送<br/>・```Redirect HTTP to HTTPS```：両方受信し，HTTPSで転送<br/>・```HTTPS Only```：HTTPSのみ受信し，HTTPSで転送 |
| Allowed HTTP Methods                    | リクエストのHTTPメソッドのうち，オリジンへの転送を許可するものを設定 | ・パスパターンが静的ファイルへのリクエストの場合，GETのみ許可．<br>・パスパターンが動的ファイルへのリクエストの場合，全てのメソッドを許可． |
| Cache Based on Selected Request Headers | オリジンへの転送を許可するリクエストヘッダーを設定する．     | ・各ヘッダー転送の全拒否，一部許可，全許可を設定できる．<br>・全許可の場合，コンテンツのCacheを生成しない． |
| Whitelist Header                        | オリジンへの転送を許可するリクエストヘッダーを設定する．     | ・```Accept-xxxxx```：アプリケーションにレスポンスして欲しいデータの種類（データ型など）を指定．<br/>・ ```CloudFront-Is-xxxxx-Viewer```：デバイスタイプのBool値が格納されている．<br>・レスポンスのヘッダーに含まれる「```X-Cache:```」が「```Hit from cloudfront```」，「```Miss from cloudfront```」のどちらで，Cacheの使用の有無を判断できる．<br/> |
| Object Caching                          | CloudFrontにコンテンツのCacheを保存しておく秒数を設定する．  | ・Origin Cache ヘッダーを選択した場合，アプリケーションからのレスポンスヘッダーのCache-Controlの値が適用される．<br>・カスタマイズを選択した場合，ブラウザのTTLとは別に設定できる． |
| TTL                                     | CloudFrontにCacheを保存しておく秒数を詳細に設定する．        | ・Min，Max，Default，の全てを0秒とすると，Cacheを無効化できる．<br>・リクエストヘッダーにCache-Control Max-Ageが指定されている場合はMinとMaxが適用され，設定されていない場合はDefault TTLが適用される．<br>・「Cache Based on Selected Request Headers = All」としている場合，最小TTLはゼロでなければならない． |
| Farward Cookies                         | オリジンへの転送を許可するCookie情報のキー名を設定する．     | ・Cookie情報キー名転送の全拒否，一部許可，全許可を設定できる．<br>・リクエストのヘッダーに含まれるCookie情報（キー名／値）が変動していると，CloudFrontに保存されたCacheがHITしない．CloudFrontはキー名／値を保持するため，変化しやすいキー名／値はWhitelistで許可しないようにする．例えば，GoogleAnalyticsのキー名（```_ga```）の値は，ブラウザによって異なるため，１ユーザがブラウザを変えるたびに，異なるCacheが生成されることになる．<br>・セッションIDはCookieヘッダーに設定されているため，フォーム送信に関わるパスパターンでは，セッションIDのキー名を許可する必要がある． |
| Query String Forwarding and Caching     | オリジンへの転送とCacheを許可するクエリパラメータ名を設定    | ・クエリストリング転送とCacheの，全拒否，一部許可，全許可を選択できる．全拒否にすると，Webサイトにクエリストリングをリクエストできなくなるので注意．<br>・異なるクエリパラメータを，別々のCacheとして保存するかどうかを設定できる． |
| Restrict Viewer Access                  | リクエストの送信元を制限するかどうかを設定できる．           | セキュリティグループで制御できるため，ここでは設定しなくてよい． |
| Compress Objects Automatically          | レスポンス時にgzipを圧縮するかどうかを設定                   | ・クライアントからのリクエストヘッダーのAccept-Encodingにgzipが設定されている場合，レスポンス時に，gzip形式で圧縮して送信するかどうかを設定する．設定しない場合，圧縮せずにレスポンスを送信する．<br>・クライアント側のダウンロード速度向上のため，基本的には有効化する． |

#### ・Invalidation

CloudFrontに保存してあるCacheを削除できる．全てのファイルのCacheを削除したい場合は「```/*```」，特定のファイルのCacheを削除したい場合は「```/<ファイルへのパス>```」，を指定する．CloudFrontに関するエラーページが表示された場合，不具合を修正した後でもCacheが残っていると，エラーページが表示されてしまうため，作業後には必ずCacheを削除する．

<br>

### Reports & analytics

#### ・Cache statistics

リクエストに関連する様々なデータを，日付別に集計したものを確認できる．

#### ・Popular objects

リクエストに関連する様々なデータを，オブジェクト別に集計したものを確認できる．

<br>

## 05-04. ネットワーキング，コンテンツ配信｜ALB

### ALB：Application Load Balancing

![ALBの機能](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/ALBの機能.png)

#### ・ALBとは

クラウドリバースプロキシサーバ，かつクラウドロードバランサーとして働く．リクエストを代理で受信し，インスタンスへのアクセスをバランスよく分配することによって，サーバへの負荷を緩和する．

| 設定項目           | 説明                                                         | 備考                                                         |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| リスナー           | ALBに割り振るポート番号お，受信するプロトコルを設定する．リバースプロキシかつロードバランサ－として，これらの通信をターゲットグループにルーティングする． |                                                              |
| ルール             | リクエストのルーティングのロジックを設定する．               |                                                              |
| ターゲットグループ | ルーティング時に使用するプロトコルと，ルーティング先のアプリケーションに割り当てられたポート番号を指定する． | ターゲットグループ内のターゲットのうち，トラフィックはヘルスチェックがOKになっているターゲットにルーティングされる． |
| ヘルスチェック     | ターゲットグループに属するプロトコルとアプリケーションのポート番号を指定して，定期的にリクエストを送信する． |                                                              |

#### ・ルールの設定例

| ユースケース                                                 | ポート    | IF                                             | THEN                                                         |
| ------------------------------------------------------------ | --------- | ---------------------------------------------- | ------------------------------------------------------------ |
| リクエストがポート```80```を指定した時に，```443```にリダイレクトしたい． | ```80```  | それ以外の場合はルーティングされないリクエスト | リダイレクト先：```https://#{host}:443/#{path}?#{query}```<br>ステータスコード：```HTTP_301``` |
| リクエストがポート```443```を指定した時に，ターゲットグループに転送したい． | ```443``` | それ以外の場合はルーティングされないリクエスト | 特定のターゲットグループ                                     |

#### ・ターゲットの指定方法

| ターゲットの指定方法 | 備考                                                         |
| -------------------- | ------------------------------------------------------------ |
| インスタンス         | ターゲットが，EC2でなければならない．                        |
| IPアドレス           | ターゲットのパブリックIPアドレスが，静的でなければならない． |
| Lambda               | ターゲットが，Lambdaでなければならない．                     |

<br>

### Webサーバ，アプリケーションにおける対応

#### ・問題

ALBからEC2へのルーティングをHTTPプロトコルとした場合，アプリケーション側で，HTTPSプロトコルを用いた処理ができなくなる．そこで，クライアントからALBに対するリクエストのプロトコルがHTTPSだった場合に，Webサーバまたはアプリケーションにおいて，ルーティングのプロトコルをHTTPSと見なすように対処する．

![ALBからEC2へのリクエストのプロトコルをHTTPSと見なす](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/ALBからEC2へのリクエストのプロトコルをHTTPSと見なす.png)

#### ・Webサーバにおける対処方法

ALBを経由したリクエストの場合，リクエストヘッダーに```X-Forwarded-Proto```が付与される．これには，ALBに対するリクエストのプロトコルの種類が．文字列で格納されている．これが「```https```」だった場合に，WebサーバへのリクエストをHTTPSであるとみなすように対処する．これにより，アプリケーションへのリクエストのプロトコルがHTTPSとなる（こちらを行った場合は，アプリケーション側の対応不要）．

**＊実装例＊**

```apacheconf
SetEnvIf X-Forwarded-Proto https HTTPS=on
```

#### ・アプリケーションにおける対処方法

ALBを経由したリクエストの場合，リクエストヘッダーに```HTTP_X_FORWARDED_PROTO```が付与される．これには，ALBに対するリクエストのプロトコルの種類が．文字列で格納されている．これが「```https```」だった場合に，アプリケーションへのリクエストをHTTPSであるとみなすように，```index.php```に追加実装を行う．

**＊実装例＊**


```php
<?php
// index.php
if (isset($_SERVER["HTTP_X_FORWARDED_PROTO"])
    && $_SERVER["HTTP_X_FORWARDED_PROTO"] == 'https') {
    $_SERVER["HTTPS"] = 'on';
}
```

<br>

### その他の留意事項

#### ・割り当てられるプライベートIPアドレス範囲

ALBに割り当てられるIPアドレス範囲には，VPCのものが適用される．そのため，EC2のSecurity Groupでは，VPCのIPアドレス範囲を許可するように設定する必要がある．

#### ・ALBのセキュリティグループ

Route53から転送されるパブリックIPアドレスを受信できるようにしておく必要がある．パブリックネットワークに公開するWebサイトであれば，IPアドレスは全ての範囲（```0.0.0.0/0```と``` ::/0```）にする．社内向けのWebサイトであれば，社内のプライベートIPアドレスのみ（```n.n.n.n/32```）を許可するようにする．

<br>

## 05-05. ネットワーキング，コンテンツ配信｜VPC

### VPC：Virtual Private Cloud（＝プライベートネットワーク）

#### ・VPCとは

クラウドプライベートネットワークとして働く．プライベートIPアドレスが割り当てられた，VPCと呼ばれるプライベートネットワークを仮想的に構築することができる．異なるAvailability Zoneに渡ってEC2を立ち上げることによって，クラウドサーバをデュアル化することできる．

![VPCが提供できるネットワークの範囲](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/VPCが提供できるネットワークの範囲.png)

<br>

### IPアドレスの割り当て

#### ・自動割り当てパブリックIPアドレス（動的IPアドレス）

動的なIPアドレスで，EC2の再構築後に変化する．

#### ・Elastic IP（静的IPアドレス）

静的なIPアドレスで，再構築後も保持される．

<br>

### Internet Gateway，NAT Gateway

![InternetGatewayとNATGateway](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/InternetGatewayとNATGateway.png)

#### ・Internet Gatewayとは

VPCの出入り口に設置され，グローバルネットワークとプライベートネットワーク間（ここではVPC）におけるNAT（静的NAT）の機能を持つ．一つのパブリックIPに対して，一つのEC2のプライベートIPを紐づけられる．詳しくは，別ノートのNAT（静的NAT）を参照せよ．

#### ・NAT Gatewayとは

NAPT（動的NAT）の機能を持つ．一つのパブリックIPに対して，複数のEC2のプライベートIPを紐づけられる．パブリックsubnetに置き，プライベートSubnetのEC2からのレスポンスを受け付ける．詳しくは，別ノートのNAPT（動的NAT）を参照せよ．

#### ・比較表


|              | Internet Gateway                                             | NAT Gateway        |
| :----------- | :----------------------------------------------------------- | :----------------- |
| **機能**     | グローバルネットワークとプライベートネットワーク間（ここではVPC）におけるNAT（静的NAT） | NAPT（動的NAT）    |
| **設置場所** | VPC上                                                        | パブリックsubnet内 |

<br>

### Route Table（= マッピングテーブル）

![ルートテーブル](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/ルートテーブル.png)

#### ・ルートテーブルとは

クラウドルータのマッピングテーブルとして働く．ルータについては，別ノートのNATとNAPTを参照せよ．

| Destination（プライベートIPの範囲） |                Target                 |
| :---------------------------------: | :-----------------------------------: |
|          ```xx.x.x.x/xx```          | Destinationの範囲内だった場合の送信先 |

#### ・ルートテーブルの種類

|          | メインルートテーブル | カスタムルートテーブル |
| -------- | -------------------- | ---------------------- |
| **機能** |                      |                        |

#### ・具体例1

上の図中で，サブネット2にはルートテーブル1が関連づけられている．サブネット2内のEC2の送信先のプライベートIPアドレスが，```10.0.0.0/16```の範囲内にあれば，インバウンド通信と見なし，local（VPC内の他サブネット）を送信先に選び，範囲外にあれば通信を破棄する．

| Destination（プライベートIPアドレス範囲） |  Target  |
| :---------------------------------------: | :------: |
|             ```10.0.0.0/16```             |  local   |
|            指定範囲以外の場合             | 通信破棄 |

#### ・具体例2

上の図中で，サブネット3にはルートテーブル2が関連づけられている．サブネット3内のEC2の送信先のプライベートIPアドレスが，```10.0.0.0/16```の範囲内にあれば，インバウンド通信と見なし，local（VPC内の他サブネット）を送信先に選び，```0.0.0.0/0```（local以外の全IPアドレス）の範囲内にあれば，アウトバウンド通信と見なし，インターネットゲートウェイを送信先に選ぶ．

| Destination（プライベートIPアドレス範囲） |      Target      |
| :---------------------------------------: | :--------------: |
|             ```10.0.0.0/16```             |      local       |
|              ```0.0.0.0/0```              | Internet Gateway |

<br>

### Network ACL：Network Access  Control List

![ネットワークACL](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/ネットワークACL.png)

#### ・Network ACLとは

サブネットのクラウドパケットフィルタリング型ファイアウォールとして働く．ルートテーブルとサブネットの間に設置され，双方向のインバウンドルールとアウトバウンドルールを決定する．

#### ・ACLルール

ルールは上から順に適用される．例えば，インバウンドルールが以下だった場合，ルール100が最初に適用され，サブネットに対する，全IPアドレス（```0.0.0.0/0```）からのインバウンド通信を許可していることになる．

| ルール # | タイプ                | プロトコル | ポート範囲 / ICMP タイプ | ソース    | 許可 / 拒否 |
| -------- | --------------------- | ---------- | ------------------------ | --------- | ----------- |
| 100      | すべての トラフィック | すべて     | すべて                   | 0.0.0.0/0 | ALLOW       |
| *        | すべての トラフィック | すべて     | すべて                   | 0.0.0.0/0 | DENY        |

<br>

### VPC subnet

クラウドプライベートネットワークにおけるセグメントとして働く．

#### ・パブリックsubnetとは

非武装地帯に相当する．攻撃の影響が内部ネットワークに広がる可能性を防ぐために，外部から直接リクエストを受ける，

#### ・プライベートsubnetとは

内部ネットワークに相当する．外部から直接リクエストを受けずにレスポンスを返せるように，内のNATを経由させる必要がある．

![パブリックサブネットとプライベートサブネットの設計](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/パブリックサブネットとプライベートサブネットの設計.png)

#### ・同一VPC内の各AWSリソースに割り当てる最低限のIPアドレス数

一つのVPC内には複数のSubnetが入る．そのため，SubnetのIPアドレス範囲は，Subnetの個数だけ狭めなければならない．また，VPCがもつIPアドレス範囲から，VPC内の各AWSリソースにIPアドレスを割り当てていかなければならない．VPC内でIPアドレスが枯渇しないように，　以下の手順で，割り当てを考える．

1. rfc1918 に準拠し，VPCに以下の範囲内でIPアドレスを割り当てる．

| IPアドレス                                | サブネットマスク（CIDR形式） | 範囲                 |
| ----------------------------------------- | ---------------------------- | -------------------- |
| ```10.0.0.0```  ~ ```10.255.255.255```    | ```/8```                     | ```10.0.0.0/8```     |
| ```172.16.0.0``` ~ ```172.31.255.255```   | ```/12```                    | ```172.16.0.0/12```  |
| ```192.168.0.0``` ~ ```192.168.255.255``` | ```/16```                    | ```192.168.0.0/16``` |

2. VPC内の各AWSリソースにIPアドレス範囲を割り当てる．

| AWSサービスの種類  | 最低限のIPアドレス数                    |
| ------------------ | --------------------------------------- |
| ALB                | ALB1つ当たり，8個                       |
| オートスケーリング | 水平スケーリング時のEC2最大数と同じ個数 |
| VPCエンドポイント  | VPCエンドポイント1つ当たり，1個         |
| ECS                | Elastic Network Interface 数と同じ個数  |
| Lambda             | Elastic Network Interface 数と同じ個数  |

#### ・Subnetの種類

Subnetには，役割ごとにいくつか種類がある．

| 名前                            | 役割                                    |
| ------------------------------- | --------------------------------------- |
| Public subnet (Frontend Subnet) | NATGatewayを配置する．                  |
| Private app subnet              | アプリケーション，Nginxなどを配置する． |
| Private datastore subnet        | RDS，Redisなどを配置する                |

![Subnetの種類](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/Subnetの種類.png)

<br>

### VPCエンドポイント（Private Link）

![VPCエンドポイント](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/VPCエンドポイント.png)

#### ・VPCエンドポイントとは

NAT Gatewayを使用せずに，VPCの外側とアウトバウンドな通信を行う機能．

|      | メリット                                                     |
| ---- | ------------------------------------------------------------ |
| 1    | NAT Gatewayを通過しないため，料金が少しだけ安くなる．        |
| 2    | インターネットゲートウェイを通過しないため，アウトバウンドな通信がセキュアになる． |

<br>

### VPCピアリング接続

![VPCピアリング接続](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/VPCピアリング接続.png)

#### ・VPCピアリング接続とは

異なるVPCにあるAWSリソースの間で，相互にデータ通信を行うことができる．

#### ・VPCピアリング接続ができない場合

| アカウント   | VPCのあるリージョン | VPC内のCIDRブロック    | 接続の可否 |
| ------------ | ------------------- | ---------------------- | ---------- |
| 同じ／異なる | 同じ／異なる        | 全て異なる             | **〇**     |
|              |                     | 同じものが一つでもある | ✕          |

VPC に複数の IPv4 CIDR ブロックがあり，一つでも 同じCIDR ブロックがある場合は、VPC ピアリング接続はできない．

![VPCピアリング接続不可の場合-1](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/VPCピアリング接続不可の場合-1.png)

たとえ，IPv6が異なっていても，同様である．

![VPCピアリング接続不可の場合-2](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/VPCピアリング接続不可の場合-2.png)



## 06. アプリケーションインテグレーション

### SQS：Simple Queue Service

![AmazonSQSとは](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/AmazonSQSとは.jpeg)

#### ・SQSとは

クラウドメッセージキューとして働く．異なるVPC間でも，メッセージキューを同期できる．クラウドサーバで生成されたメッセージは，一旦SQSに追加される．コマンドによってバッチが実行され，メッセージが取り出される．その後，例えば，バッチ処理によってメッセージからデータが取り出されてファイルが生成され，S3に保存されるような処理が続く．

#### ・SQSの種類

| 設定項目         | 説明 |
| ---------------- | ---- |
| スタンダード方式 |      |
| FIFO方式         |      |

<br>

### SNS：Simple Notification Service

![SNSとは](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/SNSとは.png)

#### ・SNSとは

パブリッシャーから発信されたメッセージをエンドポイントで受信し，サブスクライバーに転送するAWSリソース．

| 設定項目           | 説明                                                 |
| ------------------ | ---------------------------------------------------- |
| トピック           | 複数のサブスクリプションをグループ化したもの．       |
| サブスクリプション | エンドポイントで受信するメッセージの種類を設定する． |

#### ・サブスクリプション

| メッセージの種類 | 転送先               | 備考                                                         |
| ---------------- | -------------------- | ------------------------------------------------------------ |
| HTTPS            | 任意のドメイン名     | Chatbotのドメイン名は「```https://global.sns-api.chatbot.amazonaws.com```」 |
| Eメール          | 任意のメールアドレス |                                                              |
| JSON形式のメール | 任意のメールアドレス |                                                              |
| SQS              | SQS                  |                                                              |
| Lambda           | Lambda               |                                                              |
| SMS              | SMS                  |                                                              |

<br>

## 07. 管理，ガバナンス

### Auto Scaling

#### ・Auto Scalingとは

ユーザが指定した条件で，EC2の自動水平スケーリングを行うAWSリソース．他のスケーリングについては，ネットワークのノートを参照．

| スケールアウト      | スケールイン        |
| ------------------- | ------------------- |
| ・起動するEC2の個数 | ・終了するEC2の条件 |

![Auto-scaling](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/Auto-scaling.png)

<br>

### Chatbot

#### ・Chatbotとは

![ChatbotとSNSの連携](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/ChatbotとSNSの連携.png)

SNSを経由して，CloudWatchからの通知をチャットアプリに転送するAWSリソース．クライアントをSlackとした場合の設定を以下に示す．

| 設定項目        | 説明                                                         |
| --------------- | ------------------------------------------------------------ |
| Slackチャンネル | 通知の転送先のSlackチャンネルを設定する．                    |
| アクセス許可    | SNSを介して，CloudWatchにアクセスするためのロールを設定する． |
| SNSトピック     | CloudWatchへのアクセス時経由する，SNSトピックを設定する．    |

<br>

### CloudTrail

#### ・CloudTrailとは

IAMユーザによる操作や，ロールのアタッチの履歴を記録し，ログファイルとしてS3に転送する．CloudWatchと連携することもできる．

![CloudTrailとは](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/CloudTrailとは.jpeg)

<br>

## 07-02. 管理，ガバナンス｜CloudWatch


### CloudWatch

#### ・AWS-CLI

**＊コマンド例＊**

```bash
# CloudWatchのアラームの状態を変更する．
aws cloudwatch set-alarm-state --alarm-name "Alarm名" --state-value ALARM --state-reason "アラーム文言"
```

<br>

### CloudWatchエージェント

#### ・CloudWatchエージェントとは

EC2インスタンス内で発生したデータを収集し，CloudWatchに対してプッシュする常駐システムのこと．

#### ・CloudWatchエージェントの設定

CloudWatchエージェントは，```/opt/aws/amazon-cloudwatch-agent/bin/config.json```ファイルの定義を元に，実行される．設定ファイルは，分割できる．

| セクションの種類        | 説明                                   | 備考                                                         |
| ----------------------- | -------------------------------------- | ------------------------------------------------------------ |
| ```agent```セクション   | CloudWatchエージェント全体を設定する． | ・ウィザードを使用した場合，このセクションの設定はスキップされる．<br>・実装しなかった場合，デフォルト値が適用される． |
| ```metrics```セクション |                                        | ・ウィザードを使用した場合，このセクションの設定はスキップされる．<br>・実装しなかった場合，何も設定されない． |
| ```logs```セクション    |                                        |                                                              |

設定後，```amazon-cloudwatch-agent-ctl```コマンドで設定ファイルを読み込ませる．

**＊コマンド例＊**

```bash
# EC2内にある設定ファイルを，CloudWatchエージェントに読み込ませる（再起動を含む）
$ /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json

# プロセスのステータスを確認
$ /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -m ec2 -a status
```

```bash
# 設定ファイルが読み込まれたかを確認

### CloudWatchエージェントのプロセスのログファイル
$ tail -f /opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log

### 設定ファイルの構文チェックのログファイル
$ tail -f /opt/aws/amazon-cloudwatch-agent/logs/configuration-validation.log

### OS起動時にデーモンが稼働するように設定されているかを確認
$ systemctl list-unit-files --type=service
```

#### ・logセクションのみの場合

CloudWatchエージェントを使用して，CloudWatchにログファイルをプッシュするだけであれば，設定ファイル（```/opt/aws/amazon-cloudwatch-agent/bin/config.json```）には```log```セッションのみの実装で良い．```run_as_user```には，プロセスのユーザ名（例：```cwagent```）を設定する．

**＊実装例＊**

```json
{
  "agent": {
    "run_as_user": "cwagent"
  },
  "logs": {
    "logs_collected": {
      "files": {
        "collect_list": [
          {
            "file_path": "/var/log/nginx/error.log",
            "log_group_name": "/example-www/var/log/nginx/error_log",
            "log_stream_name": "{instance_id}"
          },
          {
            "file_path": "/var/log/php-fpm/error.log",
            "log_group_name": "/example-www/var/log/php-fpm/error_log",
            "log_stream_name": "{instance_id}"
          }
        ]
      }
    }
  }
}
```

<br>

### CloudWatch Logs

####  ・CloudWatch Logsとは

クラウドログサーバとして働く．様々なAWSリソースで生成されたログファイルを収集できる．

| 設定項目                     | 説明                                                       | 備考                                                         |
| ---------------------------- | ---------------------------------------------------------- | ------------------------------------------------------------ |
| ロググループ                 | ログストリームをグループ化して収集するかどうかを設定する． | 基本的に，ログファイルはグループ化せずに，一つのロググループには一つのログストリームしか含まれないようにする．ただし，EC2インスタンスを冗長化しあばあ |
| メトリクスフィルター         | 紐づくロググループで，出現を監視する文字列を設定する．     |                                                              |
| サブスクリプションフィルター |                                                            |                                                              |
| Logs Insights                | クエリを使用してログを抽出できる．                         |                                                              |

#### ・メトリクスフィルターの詳細項目

| 設定項目           | 説明                                                         | 備考                                                       |
| ------------------ | ------------------------------------------------------------ | ---------------------------------------------------------- |
| フィルターパターン | 紐づくロググループで，メトリクス値増加のトリガーとする文字列を設定する． | 大文字と小文字を区別するため，網羅的に設定する必要がある． |
| 名前空間           | 紐づくロググループが属する名前空間を設定する．CloudWatchLogsが，設定した名前空間に対して，値を発行する． |                                                            |
| メトリクス         | 紐づくロググループが属する名前空間内のメトリクスを設定する．CloudWatchLogsが，設定したメトリクスに対して，値を発行する． |                                                            |
| メトリクス値       | フィルターパターンで文字列が検出された時に，メトリクスに対して発行する値のこと． | 例えば「検出数」を発行する場合は，「１」を設定する．       |

#### ・フィルターパターンのテンプレート

```
# OR条件で大文字小文字を考慮し，「XXXXX:」を検出
?"WARNING:" ?"Warning:" ?"ERROR:" ?"Error:" ?"CRITICAL:" ?"Critical:" ?"EMERGENCY:" ?"Emergency:" ?"ALERT:" ?"Alert:"
```

```
# OR条件で大文字小文字を考慮し，「XXXXX message」を検出
?"WARNING message" ?"Warning message" ?"ERROR message" ?"Error message" ?"CRITICAL message" ?"Critical message" ?"EMERGENCY message" ?"Emergency message" ?"ALERT message" ?"Alert message"
```

#### ・名前空間，メトリクス，ディメンションとは

![名前空間，メトリクス，ディメンション](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/名前空間，メトリクス，ディメンション.png)

#### ・CloudWatchLogsエージェントの設定（非推奨）

2020/10/05現在は非推奨で，CloudWatchエージェントへの設定の移行が推奨されている．

**＊実装例＊**

confファイルを，EC2内の```etc```ディレクトリ下に設置する．

```
#############################
# /var/awslogs/awscli.conf
#############################

[plugins]
cwlogs = cwlogs
[default]
region = ap-northeast-1
```

OS，ミドルウェア，アプリケーション，の各層でログを収集するのがよい．

**＊実装例＊**

```
#############################
# /var/awslogs/awslogs.conf
#############################

# ------------------------------------------
# CentOS CloudWatch Logs
# ------------------------------------------
[/var/log/messages]

# タイムスタンプ
#（例）Jan 1 00:00:00
datetime_format = %b %d %H:%M:%S
#（例）2020-01-01 00:00:00
# datetime_format = %Y-%m-%d %H:%M:%S

# 収集したいログファイル．ここでは，CentOSのログを指定．
file = /var/log/messages

# 要勉強
buffer_duration = 5000
log_stream_name = {instance_id}
initial_position = start_of_file

# AWS上で管理するロググループ名
log_group_name = /var/log/messages

# ------------------------------------------
# Nginx CloudWatch Logs
# ------------------------------------------


# ------------------------------------------
# Application CloudWatch Logs
# ------------------------------------------

```

設定後，```awslogs```コマンドでプロセスを起動する．

**＊コマンド例＊**

```bash
# CloudWatchエージェントの再起動
# 注意: restartだとCloudWatchに反映されない時がある．
$ service awslogs restart

# もしくは
$ service awslogs stop
$ service awslogs start

# ログが新しく生成されないと変更が適用されないことがあるため，ログファイルに適当な文字列行を増やしてみる．
```

<br>

### CloudWatch Events

#### ・CloudWatch Eventsとは

イベントを検知し，指定したアクションを行う．

| イベント例                        |      | アクション例                               |
| --------------------------------- | ---- | ------------------------------------------ |
| ECSタスクスケジュール機能の有効化 | ⇒    | 決められた時間にスケジューリング機能を発火 |
| APIのコール                       | ⇒    | Lambdaによる関数の実行                     |
| AWSコンソールへのログイン         | ⇒    | SQSによるメッセージの格納                  |
| インスタンスの状態変化            | ⇒    | SNSによるメール通知                        |
| ...                               | ⇒    | ...                                        |

<br>

### CloudWatch Alarm

<br>

## 08. 開発者用ツール

### CodeDeploy

#### ・CodeDeployとは

#### ・appspecファイル

デプロイの設定を行う．

```yaml
version: 0.0

Resources:
  - TargetService:
      # 使用するAWSリソース
      Type: AWS::ECS::Service
      Properties:
        # 使用するタスク定義．<TASK_DEFINITION> とすると，自動補完してくれる．
        TaskDefinition: "<TASK_DEFINITION>"
        # 使用するロードバランサー
        LoadBalancerInfo:
          ContainerName: "xxx-container"
          ContainerPort: "80"
```

#### ・ライフサイクルイベント

<br>


## 09. カスタマーエンゲージメント

### SES：Simple Email Service

![SESとは](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/SESとは.png)

#### ・SESとは

クラウドメールサーバとして働く．メール受信をトリガーとして，アクションを実行できる．

| 設定項目           | 説明                                                         | 備考                                                         |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Domain             | SESのドメイン名を設定する．                                  | 設定したドメイン名には，「```10 inbound-smtp.us-east-1.amazonaws.com```」というMXレコードタイプの値が紐づく． |
| Email Addresses    | 送信先として認証するメールアドレスを設定する．設定するとAWSからメールが届くので，指定されたリンクをクリックする． | Sandboxモードの時だけ機能する．                              |
| Sending Statistics | SESで収集されたデータをメトリクスで確認できる．              | ```Request Increased Sending Limits```のリンクにて，Sandboxモードの解除を申請できる． |
| SMTP Settings      | SMTP-AUTHの接続情報を確認できる．                            | アプリケーションの25番ポートは送信制限があるため，465番を使用する．これに合わせて，SESも受信で465番ポートを使用するようにする． |
| Rule Sets          | メールの受信したトリガーとして実行するアクションを設定できる． |                                                              |
| IP Address Filters |                                                              |                                                              |

#### ・構築リージョンの制約

SESは連携するAWSリソースと同じリージョンに構築しなければならない．

#### ・Sandboxモードの解除

SESはデフォルトではSandboxモードになっている．Sandboxモードでは以下の制限がかかっており．サポートセンターに解除申請が必要である．

| 制限     | 説明                                          |
| -------- | --------------------------------------------- |
| 送信制限 | SESで認証したメールアドレスのみに送信できる． |
| 受信制限 | 1日に200メールのみ受信できる．                |

#### ・AWSにおけるSMTP-AUTHの仕組み

一般的なSMTP-AUTHでは，クライアントユーザの認証が必要である．同様にして，AWSにおいてもこれが必要であり，IAMユーザを用いてこれを実現する．送信元となるアプリケーションにIAMユーザを紐付け，アプリケーションがSESを介してメールを送信する時，IAMユーザがもつユーザ名とパスワードを認証に用いる．ユーザ名とパスワードは後から確認できないため，メモしておくこと．SMTP-AUTHの仕組みについては，別ノートを参照せよ．

#### ・Rule Sets

| 設定項目 | 説明                                                         |
| -------- | ------------------------------------------------------------ |
| Recipiet | 受信したメールアドレスで，何の宛先の時にこれを許可するかを設定する． |
| Actions  | 受信を許可した後に，これをトリガーとして実行するアクションを設定する． |

<br>

## 10. ビジネスアプリケーション

### WorkMail

#### ・WorkMailとは

AWSから提供されている．Gmail，サンダーバード，Yahooメールなどと同類のアプリケーション．

| 設定項目              | 説明                                                     | 備考                                                         |
| --------------------- | -------------------------------------------------------- | ------------------------------------------------------------ |
| Users                 | WorkMailで管理するユーザを設定する．                     |                                                              |
| Domains               | ユーザに割り当てるメールアドレスのドメイン名を設定する． | ```@{組織名}.awsapps.com```をドメイン名としてもらえる．ドメイン名の検証が完了した独自ドメイン名を設定することもできる． |
| Access Controle rules | 受信するメール，受信を遮断するメール，の条件を設定する． |                                                              |

<br>

## 11. 暗号化とPKI

### Certificate Manager

#### ・Certificate Managerとは

認証局であるATSによって認証されたSSLサーバ証明書を管理できるAWSリソース．

| 自社の中間認証局名         | ルート認証局名 |
| -------------------------- | -------------- |
| ATS：Amazon Trust Services | Starfield社    |

| 設定項目   | 説明                                       |
| ---------- | ------------------------------------------ |
| ドメイン名 | 認証をリクエストするドメイン名を設定する． |
| 検証の方法 | DNS検証かEmail検証かを設定する．           |

#### ・セキュリティポリシー

許可するプロトコルを定義したルールこと．SSL/TLSプロトコルを許可しており，対応できるバージョンが異なるため，ブラウザがそのバージョンのSSL/TLSプロトコルを使用できるかを認識しておく必要がある．

|                      | Policy-2016-08 | Policy-TLS-1-1 | Policy-TLS-1-2 |
| -------------------- | :------------: | :------------: | :------------: |
| **Protocol-TLSv1**   |       〇       |       ✕        |       ✕        |
| **Protocol-TLSv1.1** |       〇       |       〇       |       ✕        |
| **Protocol-TLSv1.2** |       〇       |       〇       |       〇       |

#### ・DNS検証

CNAMEレコードランダムトークンを用いて，ドメイン名の所有者であることを証明する方法．ACMによって生成されたCNAMEレコードランダムトークンが提供されるので，これをRoute53に設定しておけば，ACMがこれを検証し，証明書を発行してくれる．

#### ・SSLサーバ証明書の種類

DNS検証またはEメール検証によって，ドメイン名の所有者であることが証明されると，発行される．証明書は，PKIによる公開鍵検証に用いられる．

| 証明書の種類         | 説明                                             |
| -------------------- | ------------------------------------------------ |
| ワイルドカード証明書 | 証明するドメイン名にワイルドカードを用いたもの． |

#### ・SSLサーバ証明書の設置場所パターン

AWSの使用上，ACM証明書を設置できないAWSリソースに対しては，外部の証明書を手に入れて設置する．HTTPSによるSSLプロトコルを受け付けるネットワークの最終地点のことを，SSLターミネーションという．

| パターン<br>（Route53には必ず設置）          | SSLターミネーション<br>（HTTPSの最終地点） |
| -------------------------------------------- | ------------------------------------------ |
| Route53 → ALB(+ACM証明書) → EC2              | ALB                                        |
| Route53 → ALB(+ACM証明書) → EC2(+外部証明書) | EC2                                        |
| Route53 → NLB → EC2(+外部証明書)             | EC2                                        |
| Route53 → EC2(+外部証明書)                   | EC2                                        |
| Route53 → CloudFront(+ACM証明書) → ALB → EC2 | CloudFront                                 |
| Route53 → CloudFront(+ACM証明書) → EC2       | CloudFront                                 |
| Route53 → CloudFront(+ACM証明書) → S3        | CloudFront                                 |
| Route53 → Lightsail(+ACM証明書)              | Lightsail                                  |

<br>

## 12. セキュリティ

### AWSリソース vs. サイバー攻撃

| サイバー攻撃の種類 | 対抗するAWSリソースの種類                                    |
| ------------------ | ------------------------------------------------------------ |
| マルウェア         | なし                                                         |
| 傍受，盗聴         | VPC内の特にプライベートサブネット間のピアリング接続．VPC外を介さずにデータを送受信できる． |
| ポートスキャン     | セキュリティグループ                                         |
| DDoS               | Shield                                                       |
| ゼロディ           | WAF                                                          |
| インジェクション   | WAF                                                          |
| XSS                | WAF                                                          |
| データ漏洩         | KMS，CloudHSM                                                |
| 組織内部での裏切り | IAM                                                          |

<br>

### WAF：Web Applicarion Firewall

#### ・WAFとは

| 設定項目                          | 説明                                                         | 備考                                                    |
| --------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------- |
| Web ACLs：Web Access Control List | 各トリガーとAllow／Blockアクションの関連付けを「ルール」とし，これをセットで設定する． | アタッチするAWSリソースに合わせて，リージョンが異なる． |
| IP sets                           | アクション実行のトリガーとなるIPアドレス                     |                                                         |
| Regex pattern sets                | アクション実行のトリガーとなるURL上の文字列                  |                                                         |
| Rule groups                       |                                                              |                                                         |
| AWS Markets                       |                                                              |                                                         |

#### ・Web ACLsにおけるルール

| 設定項目                 | 説明                                                         | 備考                                  |
| ------------------------ | ------------------------------------------------------------ | ------------------------------------- |
| Overview                 | WAFによってAllow/Blockされたリクエストのアクセスログを確認できる． |                                       |
| Rules                    | 順番にルールを判定し，一致するルールがあればアクションを実行する．この時，一致するルールの後にあるルールは．判定されない． | ルールの設定を参照せよ．              |
| Associated AWS resources | WAFをアタッチするAWSリソースを設定する．                     | CloudFront，ALBなどにアタッチできる． |
| Logging and metrics      | アクセスログをKinesis Data Firehoseに出力するように設定する． |                                       |

#### ・ルールの設定例

**＊具体例＊**

アプリケーションにおいて，特定のファイルパスにアクセスできる送信元IPアドレスを，社内だけに制限する．

| 順番           | If a request      | Statement1                                             | Statement2                                             | アクション | 挙動                                                         |
| -------------- | ----------------- | ------------------------------------------------------ | ------------------------------------------------------ | ---------- | ------------------------------------------------------------ |
| 0              | matches all (AND) | Originates from an IP address in                       | ・URI path<br>・Matches pattern from regex pattern set | Allow      | 特定の送信元IPアドレスが，指定したファイルパスにアクセスすることを許可する． |
| 1              | matches           | ・URI path<br>・Matches pattern from regex pattern set | なし                                                   | Block      | 0番目で合致しなかった送信元IPが，指定したファイルパスにアクセスすることを拒否する． |
| Default Action |                   |                                                        |                                                        | Allow      | 1番目で合致しなかった送信元IPアドレスが，1番目以外の全てのファイルパスにアクセスすることを許可する． |

**＊具体例＊**

アプリケーション全体にアクセスできる送信元IPアドレスを，社内だけに制限する．

| 順番           | If a request | Statement1                       | Statement2 | アクション | 挙動                                                         |
| -------------- | ------------ | -------------------------------- | ---------- | ---------- | ------------------------------------------------------------ |
| 0              | matches      | Originates from an IP address in | なし       | Allow      | 特定の送信元IPアドレスが，全てのファイルパスにアクセスすることを許可する． |
| Default Action |              |                                  |            | Block      | 1番目で合致しなかった送信元IPアドレスが，全てのファイルパスにアクセスすることを拒否する． |

<br>

## 12-02. セキュリティ｜IAM：Identify and Access Management

### IAMポリシー，IAMステートメント

#### ・IAMポリシーとは

実行権限のあるアクションが定義されたIAMステートメントのセットを持つ，JSON型オブジェクトデータのこと．

#### ・IAMポリシーの種類

| IAMポリシーの種類                  | 説明                                                         |
| ---------------------------------- | ------------------------------------------------------------ |
| アイデンティティベースのポリシー   | IAMユーザ，IAMグループ，IAMロール，に付与するためのポリシーのこと． |
| リソースベースのインラインポリシー | 単一のAWSリソースにインポリシーのこと．                      |
| アクセスコントロールポリシー       | json形式で定義する必要が無いポリシーのこと．                 |

**＊具体例＊**

以下に，EC2の読み出しのみ権限（```AmazonEC2ReadOnlyAccess```）を付与できるポリシーを示す．このIAMポリシーには，他のAWSリソースに対する権限も含まれている．

```yaml
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "ec2:Describe*",
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": "elasticloadbalancing:Describe*",
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:ListMetrics",
        "cloudwatch:GetMetricStatistics",
        "cloudwatch:Describe*"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": "autoscaling:Describe*",
      "Resource": "*"
    }
  ]
}
```

####  ・IAMステートメントとは

実行権限のあるアクションを定義した，JSON型オブジェクトデータのこと．

**＊具体例＊**

以下のポリシーを付与されたAWSリソースは，任意のSSMパラメータを取得できるようになる．

```yaml
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "",
      "Effect": "Allow",
      "Action": [
        "ssm:GetParameters"
      ],
      "Resource": "*"
    }
  ]
}

```

| Statementの項目 | 説明                                             |
| --------------- | ------------------------------------------------ |
| Sid             | 任意の一意な文字列を設定する．空文字でもよい．   |
| Effect          | 許可または拒否を設定する．                       |
| Action          | リソースに対して実行できるアクションを設定する． |
| Resource        | アクションの実行対象に選べるリソースを設定する． |


以下に主要なアクションを示す．

| アクション名 | 説明                   |
| ------------ | ---------------------- |
| Create       | リソースを構築する．   |
| Describe     | リソースを表示する．   |
| Delete       | リソースを削除する．   |
| Get          | リソースを取得する．   |
| Put          | リソースを上書きする． |

<br>

### アイデンティティベースのポリシー

#### ・アイデンティティベースのポリシーとは

IAMユーザ，IAMグループ，IAMロール，に付与するためのポリシーのこと．

#### ・AWS管理ポリシー

AWSが提供しているポリシーのこと．アタッチ式のポリシーのため，すでにアタッチされていても，他のものにもアタッチできる．

#### ・カスタマー管理ポリシー

ユーザが独自に作成したポリシーのこと．すでにアタッチされていても，他のものにもアタッチできる．

#### ・インラインポリシー

単一のアイデンティティに付与するためのポリシーのこと．組み込み式のポリシーのため，アイデンティティ間で共有してアタッチすることはできない．

**＊実装例＊**

IAMユーザ，IAMグループ，IAMロールは，ユーザーアカウントのすべての ACM 証明書を一覧表示できるようになる．

```json
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Effect":"Allow",
      "Action":"acm:ListCertificates",
      "Resource":"*"
    }
  ]
}
```

**＊実装例＊**

IAMユーザ，IAMグループ，IAMロールは，全てのAWSリソースに，任意のアクションを実行できる．

```json
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Effect":"Allow",
      "Action":"*",
      "Resource":"*"
    }
  ]
}
```

<br>

### リソースベースのインラインポリシー

#### ・リソースベースのインラインポリシーとは

単一のAWSリソースにインポリシーのこと．すでにアタッチされていると，他のものにはアタッチできない．

#### ・バケットポリシー

S3にアタッチされる，自身へのアクセスを制御するためのインラインポリシーのこと．

#### ・ライフサイクルポリシー

ECRにアタッチされる，イメージの有効期間を定義するポリシー．コンソール画面から入力できるため，基本的にポリシーの実装は不要であるが，TerraformなどのIaCツールでは必要になる．

**＊実装例＊**

```json
{
  "rules": [
    {
      "rulePriority": 1,
      "description": "Keep last 10 images untagged",
      "selection": {
        "tagStatus": "untagged",
        "countType": "imageCountMoreThan",
        "countNumber": 10
      },
      "action": {
        "type": "expire"
      }
    },
    {
      "rulePriority": 2,
      "description": "Keep last 10 images any",
      "selection": {
        "tagStatus": "any",
        "countType": "imageCountMoreThan",
        "countNumber": 10
      },
      "action": {
        "type": "expire"
      }
    }
  ]
}

```

#### ・信頼ポリシー

ロールにアタッチされる，Assume Roleを行うためのインラインポリシーのこと．

**＊実装例＊**

例えば，以下の信頼ポリシーを任意のロールに付与したとする．その場合，```Principal```の```ecs-tasks```が信頼されたエンティティと見なされ，ロールをアタッチすることができるようになる．

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "",
      "Effect": "Allow",
      "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

信頼ポリシーでは，IAMユーザを信頼されたエンティティとして設定することもできる．

**＊実装例＊**

例えば，以下の信頼ポリシーを任意のロールに付与したとする．その場合，```Principal```のIAMユーザが信頼されたエンティティと見なされ，ロールをアタッチすることができるようになる．

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::<アカウントID>:user/<ユーザ名>"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "<適当な文字列>"
        }
      }
    }
  ]
}
```

<br>

### IAMポリシーを付与できる対象

#### ・IAMユーザに対する付与

![IAMユーザにポリシーを付与](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/IAMユーザにポリシーを付与.jpeg)

#### ・IAMグループに対する付与

![IAMグループにポリシーを付与](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/IAMグループにポリシーを付与.jpeg)

#### ・IAMロールに対する付与

![IAMロールにポリシーを付与](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/IAMロールにポリシーを付与.jpeg)

<br>

### ルートユーザ，IAMユーザ

#### ・ルートユーザとは

全ての権限をもったアカウントのこと．

#### ・IAMユーザとは

特定の権限をもったアカウントのこと．

#### ・AWS-CLI

```bash
# ユーザ名を変更する．
$ aws iam update-user --user-name <現行のユーザ名> --new-user-name <新しいユーザ名>
```

#### ・AWS-CLIのための機密情報ファイル

AWS-CLIでクラウドインフラを操作するためには，機密情報ファイルに定義されたプロファイルが必要である．

```bash
$ aws configure set aws_access_key_id "XXXXX"
$ aws configure set aws_secret_access_key "XXXXX"
$ aws configure set aws_default_region "ap-northeast-1"
```

```
// Linux，Unixの場合：$HOME/.aws/<機密情報ファイル名>
// Windowsの場合：%USERPROFILE%\.aws\<機密情報ファイル名>

[default]
aws_access_key_id=<アクセスキー>
aws_secret_access_key=<シークレットキー>

[user1]
aws_access_key_id=<アクセスキー>
aws_secret_access_key=<シークレットキー>
```

<br>

### IAMグループ

#### ・IAMグループとは

IAMユーザをグループ化したもの．IAMグループごとにIAMロールを付与すれば，IAMユーザのIAMロールを管理しやすくなる．

![グループ](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/グループ.png)

<br>

### IAMロール

#### ・IAMロールとは

IAMポリシーのセットを持つ

#### ・IAMロールの種類

| IAMロールの種類                  | 説明                                              | 例                                   |
| -------------------------------- | ------------------------------------------------- | ------------------------------------ |
| サービスリンクロール             | AWSリソースを構築した時に自動的に作成されるロール | Lambdaの構築時に構築される実行ロール |
| クロスアカウントのアクセスロール |                                                   |                                      |
| プロバイダのアクセスロール       |                                                   |                                      |

#### ・IAMロールを付与する方法

まず，IAMグループに対して，IAMロールを紐づける．そのIAMグループに対して，IAMロールを付与したいIAMユーザを追加していく．

![グループに所属するユーザにロールを付与](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/グループに所属するユーザにロールを付与.png)

<br>

## 12-03. セキュリティ｜STS：Security Token Service

### STS

#### ・STSとは

<br>

### STSの仕組み

#### 1. IAMロールに信頼ポリシーを付与

IAMロールの信頼ポリシーにおいて，ユーザの```ARN```を信頼されたエンティティとして設定しておく．これにより，そのユーザに対して，ロールをアタッチできるようになる．

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::<アカウントID>:user/<ユーザ名>"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "<適当な文字列>"
        }
      }
    }
  ]
}
```

#### 2. ロールを引き受けたアカウント情報をリクエスト

信頼されたエンティティ（ユーザ）から，STS（```https://sts.amazonaws.com```）に対して，ロールのアタッチをリクエストする．

```bash
#!/bin/bash

# 事前に環境変数にインフラ環境名を代入する．
case $ENV in
    "feat")
        aws_account_id="<作業環境アカウントID>"
        aws_access_key_id="<作業環境アクセスキーID>"
        aws_secret_access_key="<作業環境シークレットアクセスキー>"
        aws_iam_role_external_id="<信頼ポリシーに設定した外部ID>"
    ;;
    "stg")
        aws_account_id="<ステージング環境アカウントID>"
        aws_access_key_id="<ステージング環境アクセスキーID>"
        aws_secret_access_key="<ステージング環境シークレットアクセスキー>"
        aws_iam_role_external_id="<信頼ポリシーに設定した外部ID>"
    ;;
    "prd")
        aws_account_id="<本番環境アカウントID>"
        aws_access_key_id="<本番環境アクセスキーID>"
        aws_secret_access_key="<本番環境シークレットアクセスキー>"
        aws_iam_role_external_id="<信頼ポリシーに設定した外部ID>"
    ;;
    *)
        echo "The parameter ${ENV} is invalid."
        exit 1
    ;;
esac

# 信頼されたエンティティのアカウント情報を設定する．
aws configure set aws_access_key_id "$aws_account_id"
aws configure set aws_secret_access_key "$aws_secret_access_key"
aws configure set aws_default_region "ap-northeast-1"

# https://sts.amazonaws.com に，ロールのアタッチをリクエストする．
aws_sts_credentials="$(aws sts assume-role \
  --role-arn "arn:aws:iam::${aws_access_key_id}:role/${ENV}-<アタッチしたいIAMロール名>" \
  --role-session-name "<任意のセッション名>" \
  --external-id "$aws_iam_role_external_id" \
  --duration-seconds "<セッションの有効秒数>" \
  --query "Credentials" \
  --output "json")"
```

STSへのリクエストの結果，ロールがアタッチされた新しいIAMユーザ情報を取得できる．この情報には有効秒数が存在し，期限が過ぎると新しいIAMユーザになる．秒数の最大値は，該当するIAMロールの概要の最大セッション時間から変更できる．

![AssumeRole](https://raw.githubusercontent.com/Hiroki-IT/tech-notebook/master/images/AssumeRole.png)

レスポンスされるデータは以下の通り．

```json
{
  "AssumeRoleUser": {
    "AssumedRoleId": "<セッションID>:<セッション名>",
    "Arn": "arn:aws:sts:<新しいアカウントID>:assumed-role/<IAMロール名>/<セッション名>"
  },
  "Credentials": {
    "SecretAccessKey": "<シークレットアクセスキー>",
    "SessionToken": "<セッショントークン文字列>",
    "Expiration": "<セッションの期限>",
    "AccessKeyId": "<アクセスキーID>"
  }
}
```

#### 3. レスポンスされたデータからアカウント情報を抽出

jqを使用して，JSONデータからアカウント情報を抽出する．

jq：https://stedolan.github.io/jq/


```bash
#!/bin/bash

cat << EOF > assumed_user.sh
export AWS_ACCESS_KEY_ID="$(echo "$aws_sts_credentials" | jq -r '.AccessKeyId')"
export AWS_SECRET_ACCESS_KEY="$(echo "$aws_sts_credentials" | jq -r '.SecretAccessKey')"
export AWS_SESSION_TOKEN="$(echo "$aws_sts_credentials" | jq -r '.SessionToken')"
export AWS_ACCOUNT_ID="<アカウントID>"
export AWS_DEFAULT_REGION="ap-northeast-1"
EOF
```

#### 4. 接続確認

AssumeRole

```bash
#!/bin/bash

aws s3 ls --profile <プロファイル名>
2020-xx-xx xx:xx:xx <tfstateファイルが管理されるバケット名>
```

<br>

## 13. コスト管理

### コスト管理の観点

#### ・スペック

#### ・時間単価

#### ・数量

#### ・月額料金

<br>

### EBS

#### ・ボリュームサイズ

ボリュームの使用率にかかわらず，構築されたボリュームの合計サイズに基づいて，料金が発生する．そのため，安易に500GiBを選んではいけない．

<br>

### ECS

#### ・ECR

500MBを超えると，請求が発生するため，古いイメージを定期的に削除する必要がある．

<br>

### SES

#### ・送受信数

受信は```1000件/月```まで，送信は```62000/月```まで無料である．